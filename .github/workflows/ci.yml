name: CI - QUALIDADE

on:
  pull_request:
    branches: [ develop ]
  push:
    branches: [ develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  # ============================================================
  # 1) SETUP ‚Äî prepara runner, cache, melos, codegen (se houver)
  # ============================================================
  setup:
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.head_ref, 'dependabot/') }}
    timeout-minutes: 10
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}      
      tags: ${{ steps.detect_tag.outputs.tags }}

    steps:
      - name: ‚¨áÔ∏è Checkout (completo)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive
          lfs: true

      - name: ‚úÖ Validar paths locais em pubspecs
        run: |
          BAD=$(grep -R '\\\\' -n --include=pubspec.yaml || true)
          if [ -n "$BAD" ]; then
            echo "‚ùå Encontrados paths com barra invertida em pubspec.yaml:"
            echo "$BAD"
            exit 1
          fi

      - name: Garantir fetch das tags
        run: git fetch --tags

      - name: Detectar tag associada ao commit
        id: detect_tag
        run: |
          TAGS=$(git tag --points-at HEAD)
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: üîê Secret Scan (detect-secrets)
        run: |
          echo "üîç Executando varredura de segredos..."
          if [ -f ./scripts/ci-git-secret-scan.sh ]; then
            chmod +x ./scripts/ci-git-secret-scan.sh
            ./scripts/ci-git-secret-scan.sh
          else
            echo "‚ö†Ô∏è Script de secret scan N√ÉO encontrado ‚Äî abort."
            exit 1
          fi

      - name: ‚öôÔ∏è Setup-env (Flutter + Melos + cache)
        uses: ./.github/actions/setup-env

      # Conditional cleanup if Flutter version changed (keeps cache healthy)
      - name: üßπ Limpar artefatos se vers√£o do Flutter mudou
        if: env.FLUTTER_VERSION != ''
        run: |
          echo "üåÄ Vers√£o atual do Flutter: $FLUTTER_VERSION"
          CACHE_META="$HOME/.pub-cache/flutter-version.txt"
          if [ ! -f "$CACHE_META" ]; then
            echo "$FLUTTER_VERSION" > "$CACHE_META"
          else
            OLD_VERSION=$(cat "$CACHE_META")
            if [ "$OLD_VERSION" != "$FLUTTER_VERSION" ]; then
              echo "‚ö†Ô∏è Flutter mudou ‚Üí Limpando .dart_tool e cache hosted"
              rm -rf .dart_tool || true
              rm -rf $HOME/.pub-cache/hosted || true
              echo "$FLUTTER_VERSION" > "$CACHE_META"
            else
              echo "‚úî Vers√£o igual ‚Äî mantendo cache"
            fi
          fi

      # Extra cache restore (safe/redundant with setup-env but explicit for workflow)
      - name: üíæ Restaurar/Criar Cache de Depend√™ncias (pub & .dart_tool)
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool/
          key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-pub-

      - name: üìå Validar melos.yaml e listar pacotes
        run: |
          if [ ! -f melos.yaml ]; then
            echo "‚ùå melos.yaml ausente"
            exit 1
          fi
          # melos j√° instalado no setup-env
          melos list || true

      - name: üßπ Limpar .dart_tool e overrides antigos
        run: |
          rm -rf .dart_tool || true
          find . -name "pubspec_overrides.yaml" -print -exec sed -i 's|\\\\|/|g' {} \;

      - name: üì¶ melos bootstrap (gera links e .dart_tool corretos)
        run: melos bootstrap

      - name: üß¨ Executar Codegen via Melos (se existir)
        run: |
          if grep -qE '^[[:space:]]*codegen:' melos.yaml; then
            echo "‚ñ∂Ô∏è Rodando 'melos run codegen'"
            melos run codegen
          else
            echo "‚ÑπÔ∏è Nenhum script 'codegen' encontrado em melos.yaml"
          fi

      - name: üìÇ Debug Estrutura (curto)
        run: |
          echo "PWD: $(pwd)"
          ls -la | sed -n '1,200p'

  # ============================================================
  # 2) AN√ÅLISE EST√ÅTICA + FORMATA√á√ÉO
  # ============================================================
  analise_e_formato:
    needs: setup
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.head_ref, 'dependabot/') }}

    steps:
      - name: ‚¨áÔ∏è Checkout (r√°pido)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup-env (garante flutter/dart no runner)
        uses: ./.github/actions/setup-env

      - name: üîÑ Re-Bootstrap Melos (garante links v√°lidos)
        run: melos bootstrap

      - name: üìê Verificar Formata√ß√£o (CR√çTICO)
        # falha bloqueante para PRs
        run: melos run format:check

      - name: üßê An√°lise Est√°tica (CR√çTICO)
        run: melos run analyze

      - name: üìù Report ‚Äî Depend√™ncias desatualizadas (informativo)
        run: melos exec -- dart pub outdated || true

  # ============================================================
  # 3) TESTES + COBERTURA
  # ============================================================
  testes_unidade:
    needs: setup
    runs-on: ubuntu-latest
    outputs:
      coverage-path: coverage/html
    if: ${{ !startsWith(github.head_ref, 'dependabot/') }}

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup-env
        uses: ./.github/actions/setup-env

      - name: üîÑ Re-Bootstrap Melos
        run: melos bootstrap

      - name: üõ†Ô∏è Instalar lcov (para gerar relat√≥rios HTML)
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: üß™ Executar Testes Unit√°rios e Cobertura (Melos)
        run: melos run test

      - name: üìÇ Combinar Cobertura (LCOV)
        run: |
          mkdir -p coverage
          find . -name "lcov.info" | while read -r file; do
            cat "$file" >> coverage/combined.lcov.info
          done

      - name: üîÑ Corrigir Caminhos do LCOV (Monorepo)
        run: |
          mkdir -p coverage
          sed -E 's|SF:/home/runner/work/[^/]*/[^/]*/||g' coverage/combined.lcov.info > coverage/lcov_tmp.info || mv coverage/combined.lcov.info coverage/lcov_tmp.info
          if grep -q "SF:lib/" coverage/lcov_tmp.info; then
            sed -E 's|SF:lib/|SF:apps/appbank/lib/|g' coverage/lcov_tmp.info > coverage/lcov_formatted.info
          else
            mv coverage/lcov_tmp.info coverage/lcov_formatted.info
          fi

      - name: üìä Gerar Relat√≥rio HTML (LCOV -> HTML)
        run: genhtml coverage/lcov_formatted.info -o coverage/html --ignore-errors source --synthesize-missing

      - name: ‚¨ÜÔ∏è Upload do Relat√≥rio HTML (Artefato)
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-cobertura-flutter
          path: coverage/html
          retention-days: 1

  # ============================================================
  # 4) BUILD + OSV SCAN
  # ============================================================
  verificacao_build:
    needs: [setup, analise_e_formato, testes_unidade]
    runs-on: ubuntu-latest
    
    if: contains(needs.setup.outputs.tags, 'complete')  

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup-env
        uses: ./.github/actions/setup-env

      - name: üîÑ Re-Bootstrap Melos
        run: melos bootstrap

      # ======================================================
      # OSV API SCANNER ‚Äî Flutter/Dart/Melos (mantido)
      # ======================================================
      - name: üîß Instalar jq/yq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          YQ_VERSION=v4.44.3
          curl -sSL https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64 -o /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: üîç Localizar pubspec.lock
        run: |
          find . -name "pubspec.lock" > lockfiles.txt
          sort -u lockfiles.txt -o lockfiles.txt
          echo "üì¶ pubspec.lock encontrados:"
          cat lockfiles.txt

      - name: üìù Preparar payload OSV.dev
        run: |
          echo '{"queries":[' > osv_queries.json
          while read -r LOCK; do
            echo "üîç Parsing $LOCK"
            JSON=$(yq -o=json '.' "$LOCK")
            echo "$JSON" | jq -c '.packages | to_entries[]' | while read -r ENTRY; do
              NAME=$(echo "$ENTRY" | jq -r '.key')
              VERSION=$(echo "$ENTRY" | jq -r '.value.version')

              if [[ "$VERSION" == *"from sdk"* ]]; then continue; fi
              if echo "$ENTRY" | grep -q '"source":"git"'; then continue; fi
              if echo "$ENTRY" | grep -q '"source":"path"'; then continue; fi

              printf '{"package":{"name":"%s","ecosystem":"Pub"},"version":"%s"},' \
                "$NAME" "$VERSION" >> osv_queries.json
            done
          done < lockfiles.txt
          # remove trailing comma safely
          sed -i 's/,$//' osv_queries.json || true
          echo "]}" >> osv_queries.json || true

      - name: üåê Query OSV API
        run: |
          curl -s -X POST "https://api.osv.dev/v1/querybatch" \
            -H "Content-Type: application/json" \
            -d @osv_queries.json > osv_response.json || true
          echo "üìÑ OSV API response:"
          cat osv_response.json || true

      - name: üìù Gerar Markdown Report OSV
        run: |
          echo "# üîç OSV.dev Vulnerability Report" > osv_report.md
          echo "" >> osv_report.md
          echo "Gerado automaticamente pelo pipeline CI/CD." >> osv_report.md
          echo "" >> osv_report.md
          echo "## üì• Resposta da API (osv_response.json)" >> osv_report.md
          echo '```json' >> osv_report.md
          cat osv_response.json >> osv_report.md || true
          echo '```' >> osv_report.md

      - name: ‚¨ÜÔ∏è Upload OSV artifacts
        uses: actions/upload-artifact@v4
        with:
          name: osv-report
          path: |
            osv_report.md
            osv_queries.json
            osv_response.json
          retention-days: 2

      - name: ‚ùå Fail on Critical/High
        run: |
          COUNT=$(jq '[.results[]?.vulns[]? | select(.severity=="CRITICAL" or .severity=="HIGH")] | length' osv_response.json 2>/dev/null || echo 0)
          if [ "$COUNT" -gt 0 ]; then
            echo "‚ùå Build bloqueado por vulnerabilidades CRITICAL/HIGH: $COUNT"
            exit 1
          fi
          echo "‚úî Nenhuma vulnerabilidade cr√≠tica/alta detectada."

      - name: üèóÔ∏è Build final (debug)
        run: melos run build_app

  summary:
    needs: [verificacao_build]
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'))
      ||
      (github.event_name == 'pull_request' && (github.base_ref == 'main' || github.base_ref == 'develop'))

    steps:
      # ==================================================
      # GitHub Summary + Badges (sempre executa)
      # ==================================================
      - name: üßæ Resumo Final do Pipeline
        if: always()
        run: |
          {
            echo "# üéØ RESUMO FINAL DO PIPELINE"
            echo ""
            echo "## ‚úÖ Etapas executadas"
            echo "- üîê Secret Scan"
            echo "- üìê Formata√ß√£o"
            echo "- üßê An√°lise Est√°tica"
            echo "- üß™ Testes Unit√°rios"
            echo "- üìä Relat√≥rio de Cobertura"
            echo "- üõ°Ô∏è OSV Scanner"
            echo "- üèóÔ∏è Build Final"
            echo ""
            if [ "${{ job.status }}" = "success" ]; then
              echo "## üü¢ Status Final: **SUCESSO TOTAL**"
              echo "![success](https://img.shields.io/badge/Pipeline-Sucesso-brightgreen?style=for-the-badge&logo=github)"
            else
              echo "## üî¥ Status Final: **FALHA NO PIPELINE**"
              echo "![fail](https://img.shields.io/badge/Pipeline-Falhou-red?style=for-the-badge&logo=github)"
            fi
            echo ""
            echo "## üìå Info"
            echo "- Branch: ${{ github.ref_name }}"
            echo "- Actor: ${{ github.actor }}"
            echo "- Workflow: ${{ github.workflow }}"
          } >> $GITHUB_STEP_SUMMARY
      - name: üîç Verificar alertas Dependabot (SCA)
        id: dependabot
        env:
          GH_TOKEN: ${{ secrets.GH_DEPENDABOT_TOKEN }}
        continue-on-error: true
        run: |
          if [ -z "${GH_TOKEN}" ]; then
            export GH_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          fi
          gh auth status || gh auth setup-git
          gh api /repos/${{ github.repository }}/dependabot/alerts --paginate > dependabot-alerts.json || echo "[]"
          COUNT=$(jq '[.[] | select(.severity=="HIGH" or .severity=="CRITICAL")] | length' dependabot-alerts.json)
          if [ "$COUNT" -gt 0 ]; then
            echo "‚ùå Dependabot encontrou $COUNT vulnerabilidades CRITICAL/HIGH"
            exit 1
          else
            echo "‚úî Nenhuma vulnerabilidade cr√≠tica/alta encontrada pelo Dependabot"
          fi

      - name: üìÇ Upload Dependabot Alerts (artefato)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependabot-alerts
          path: dependabot-alerts.json
          retention-days: 2
