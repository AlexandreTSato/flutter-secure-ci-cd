name: CI - QUALIDADE

on:
  pull_request:
    branches: [ develop ]
  push:
    branches: [ develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================
  # 1) SETUP â€” prepara runner, cache, melos, codegen (se houver)
  # ============================================================
  setup:
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.head_ref, 'dependabot/') }}
    timeout-minutes: 10
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}      
      tags: ${{ steps.detect_tag.outputs.tags }}

    steps:
      - name: â¬‡ï¸ Checkout (completo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          lfs: true

      - name: Garantir fetch das tags
        run: git fetch --tags

      - name: Detectar tag associada ao commit
        id: detect_tag
        run: |
          TAGS=$(git tag --points-at HEAD)
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: ðŸ” Secret Scan (detect-secrets)
        run: |
          echo "ðŸ” Executando varredura de segredos..."
          if [ -f ./scripts/ci-git-secret-scan.sh ]; then
            chmod +x ./scripts/ci-git-secret-scan.sh
            ./scripts/ci-git-secret-scan.sh
          else
            echo "âš ï¸ Script de secret scan NÃƒO encontrado â€” abort."
            exit 1
          fi

      - name: âš™ï¸ Setup-env (Flutter + Melos + cache)
        uses: ./.github/actions/setup-env

      # Conditional cleanup if Flutter version changed (keeps cache healthy)
      - name: ðŸ§¹ Limpar artefatos se versÃ£o do Flutter mudou
        if: env.FLUTTER_VERSION != ''
        run: |
          echo "ðŸŒ€ VersÃ£o atual do Flutter: $FLUTTER_VERSION"
          CACHE_META="$HOME/.pub-cache/flutter-version.txt"
          if [ ! -f "$CACHE_META" ]; then
            echo "$FLUTTER_VERSION" > "$CACHE_META"
          else
            OLD_VERSION=$(cat "$CACHE_META")
            if [ "$OLD_VERSION" != "$FLUTTER_VERSION" ]; then
              echo "âš ï¸ Flutter mudou â†’ Limpando .dart_tool e cache hosted"
              rm -rf .dart_tool || true
              rm -rf $HOME/.pub-cache/hosted || true
              echo "$FLUTTER_VERSION" > "$CACHE_META"
            else
              echo "âœ” VersÃ£o igual â€” mantendo cache"
            fi
          fi

      # Extra cache restore (safe/redundant with setup-env but explicit for workflow)
      - name: ðŸ’¾ Restaurar/Criar Cache de DependÃªncias (pub & .dart_tool)
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool/
          key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-pub-

      - name: ðŸ“Œ Validar melos.yaml e listar pacotes
        run: |
          if [ ! -f melos.yaml ]; then
            echo "âŒ melos.yaml ausente"
            exit 1
          fi
          # melos jÃ¡ instalado no setup-env
          melos list || true

      - name: ðŸ“¦ melos bootstrap (gera links e .dart_tool corretos)
        run: melos bootstrap

      - name: ðŸ§¬ Executar Codegen via Melos (se existir)
        run: |
          if grep -qE '^[[:space:]]*codegen:' melos.yaml; then
            echo "â–¶ï¸ Rodando 'melos run codegen'"
            melos run codegen
          else
            echo "â„¹ï¸ Nenhum script 'codegen' encontrado em melos.yaml"
          fi

      - name: ðŸ“‚ Debug Estrutura (curto)
        run: |
          echo "PWD: $(pwd)"
          ls -la | sed -n '1,200p'

  # ============================================================
  # 2) ANÃLISE ESTÃTICA + FORMATAÃ‡ÃƒO
  # ============================================================
  analise_e_formato:
    needs: setup
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.head_ref, 'dependabot/') }}

    steps:
      - name: â¬‡ï¸ Checkout (rÃ¡pido)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup-env (garante flutter/dart no runner)
        uses: ./.github/actions/setup-env

      - name: ðŸ”„ Re-Bootstrap Melos (garante links vÃ¡lidos)
        run: melos bootstrap

      - name: ðŸ“ Verificar FormataÃ§Ã£o (CRÃTICO)
        # falha bloqueante para PRs
        run: melos run format:check

      - name: ðŸ§ AnÃ¡lise EstÃ¡tica (CRÃTICO)
        run: melos run analyze

      - name: ðŸ“ Report â€” DependÃªncias desatualizadas (informativo)
        run: melos exec -- dart pub outdated || true

  # ============================================================
  # 3) TESTES + COBERTURA
  # ============================================================
  testes_unidade:
    needs: setup
    runs-on: ubuntu-latest
    outputs:
      coverage-path: coverage/html
    if: ${{ !startsWith(github.head_ref, 'dependabot/') }}

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup-env
        uses: ./.github/actions/setup-env

      - name: ðŸ”„ Re-Bootstrap Melos
        run: melos bootstrap

      - name: ðŸ› ï¸ Instalar lcov (para gerar relatÃ³rios HTML)
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: ðŸ§ª Executar Testes UnitÃ¡rios e Cobertura (Melos)
        run: melos run test

      - name: ðŸ“‚ Combinar Cobertura (LCOV)
        run: |
          mkdir -p coverage
          find . -name "lcov.info" | while read -r file; do
            cat "$file" >> coverage/combined.lcov.info
          done

      - name: ðŸ”„ Corrigir Caminhos do LCOV (Monorepo)
        run: |
          mkdir -p coverage
          sed -E 's|SF:/home/runner/work/[^/]*/[^/]*/||g' coverage/combined.lcov.info > coverage/lcov_tmp.info || mv coverage/combined.lcov.info coverage/lcov_tmp.info
          if grep -q "SF:lib/" coverage/lcov_tmp.info; then
            sed -E 's|SF:lib/|SF:apps/appbank/lib/|g' coverage/lcov_tmp.info > coverage/lcov_formatted.info
          else
            mv coverage/lcov_tmp.info coverage/lcov_formatted.info
          fi

      - name: ðŸ“Š Gerar RelatÃ³rio HTML (LCOV -> HTML)
        run: genhtml coverage/lcov_formatted.info -o coverage/html --ignore-errors source --synthesize-missing

      - name: â¬†ï¸ Upload do RelatÃ³rio HTML (Artefato)
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-cobertura-flutter
          path: coverage/html
          retention-days: 1

  # ============================================================
  # 4) BUILD + OSV SCAN
  # ============================================================
  verificacao_build:
    needs: [setup, analise_e_formato, testes_unidade]
    runs-on: ubuntu-latest
    
    if: contains(needs.setup.outputs.tags, 'complete')  

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup-env
        uses: ./.github/actions/setup-env

      - name: ðŸ”„ Re-Bootstrap Melos
        run: melos bootstrap

      # ======================================================
      # OSV API SCANNER â€” Flutter/Dart/Melos (mantido)
      # ======================================================
      - name: ðŸ”§ Instalar jq/yq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo snap install yq

      - name: ðŸ” Localizar pubspec.lock
        run: |
          find . -name "pubspec.lock" > lockfiles.txt
          sort -u lockfiles.txt -o lockfiles.txt
          echo "ðŸ“¦ pubspec.lock encontrados:"
          cat lockfiles.txt

      - name: ðŸ“ Preparar payload OSV.dev
        run: |
          echo '{"queries":[' > osv_queries.json
          while read -r LOCK; do
            echo "ðŸ” Parsing $LOCK"
            JSON=$(yq -o=json '.' "$LOCK")
            echo "$JSON" | jq -c '.packages | to_entries[]' | while read -r ENTRY; do
              NAME=$(echo "$ENTRY" | jq -r '.key')
              VERSION=$(echo "$ENTRY" | jq -r '.value.version')

              if [[ "$VERSION" == *"from sdk"* ]]; then continue; fi
              if echo "$ENTRY" | grep -q '"source":"git"'; then continue; fi
              if echo "$ENTRY" | grep -q '"source":"path"'; then continue; fi

              printf '{"package":{"name":"%s","ecosystem":"Pub"},"version":"%s"},' \
                "$NAME" "$VERSION" >> osv_queries.json
            done
          done < lockfiles.txt
          # remove trailing comma safely
          sed -i 's/,$//' osv_queries.json || true
          echo "]}" >> osv_queries.json || true

      - name: ðŸŒ Query OSV API
        run: |
          curl -s -X POST "https://api.osv.dev/v1/querybatch" \
            -H "Content-Type: application/json" \
            -d @osv_queries.json > osv_response.json || true
          echo "ðŸ“„ OSV API response:"
          cat osv_response.json || true

      - name: ðŸ“ Gerar Markdown Report OSV
        run: |
          echo "# ðŸ” OSV.dev Vulnerability Report" > osv_report.md
          echo "" >> osv_report.md
          echo "Gerado automaticamente pelo pipeline CI/CD." >> osv_report.md
          echo "" >> osv_report.md
          echo "## ðŸ“¥ Resposta da API (osv_response.json)" >> osv_report.md
          echo '```json' >> osv_report.md
          cat osv_response.json >> osv_report.md || true
          echo '```' >> osv_report.md

      - name: â¬†ï¸ Upload OSV artifacts
        uses: actions/upload-artifact@v4
        with:
          name: osv-report
          path: |
            osv_report.md
            osv_queries.json
            osv_response.json
          retention-days: 2

      - name: âŒ Fail on Critical/High
        run: |
          COUNT=$(jq '[.results[]?.vulns[]? | select(.severity=="CRITICAL" or .severity=="HIGH")] | length' osv_response.json 2>/dev/null || echo 0)
          if [ "$COUNT" -gt 0 ]; then
            echo "âŒ Build bloqueado por vulnerabilidades CRITICAL/HIGH: $COUNT"
            exit 1
          fi
          echo "âœ” Nenhuma vulnerabilidade crÃ­tica/alta detectada."

      - name: ðŸ—ï¸ Build final (debug)
        run: melos run build_app

  summary:
    needs: [verificacao_build]
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'))
      ||
      (github.event_name == 'pull_request' && (github.base_ref == 'main' || github.base_ref == 'develop'))

    steps:
      # ==================================================
      # GitHub Summary + Badges (sempre executa)
      # ==================================================
      - name: ðŸ§¾ Resumo Final do Pipeline
        if: always()
        run: |
          {
            echo "# ðŸŽ¯ RESUMO FINAL DO PIPELINE"
            echo ""
            echo "## âœ… Etapas executadas"
            echo "- ðŸ” Secret Scan"
            echo "- ðŸ“ FormataÃ§Ã£o"
            echo "- ðŸ§ AnÃ¡lise EstÃ¡tica"
            echo "- ðŸ§ª Testes UnitÃ¡rios"
            echo "- ðŸ“Š RelatÃ³rio de Cobertura"
            echo "- ðŸ›¡ï¸ OSV Scanner"
            echo "- ðŸ—ï¸ Build Final"
            echo ""
            if [ "${{ job.status }}" = "success" ]; then
              echo "## ðŸŸ¢ Status Final: **SUCESSO TOTAL**"
              echo "![success](https://img.shields.io/badge/Pipeline-Sucesso-brightgreen?style=for-the-badge&logo=github)"
            else
              echo "## ðŸ”´ Status Final: **FALHA NO PIPELINE**"
              echo "![fail](https://img.shields.io/badge/Pipeline-Falhou-red?style=for-the-badge&logo=github)"
            fi
            echo ""
            echo "## ðŸ“Œ Info"
            echo "- Branch: ${{ github.ref_name }}"
            echo "- Actor: ${{ github.actor }}"
            echo "- Workflow: ${{ github.workflow }}"
          } >> $GITHUB_STEP_SUMMARY
