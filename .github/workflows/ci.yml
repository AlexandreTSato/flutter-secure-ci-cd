name: CI - QUALIDADE

# Quando o workflow roda:
on:
  # 1) Rodar checks r√°pidos em todo Pull Request (feedback r√°pido)
  pull_request:
    branches: [main, develop]

  # 2) Rodar verifica√ß√£o + build em pushes para branches principais
  push:
    branches: [main, develop]

# Evita filas duplicadas para a mesma branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
 # -------------------
  # 1Ô∏è‚É£ Setup e Cache (Job base ‚Äî prepara o runner)
  # -------------------
  setup:
    if: ${{ !startsWith(github.head_ref, 'dependabot/') }}
    runs-on: ubuntu-latest

    timeout-minutes: 10
    outputs:
      cache-key: ${{ steps.cache.outputs.cache-hit }}

    steps:

      # Debug inicial
      - name: üîé Debug Head Ref Description
        run: | 
          echo "Head Ref is: ${{ github.head_ref }}"

      # Checkout completo
      - name: ‚¨áÔ∏è Checkout (completo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          lfs: true
          token: ${{ secrets.GITHUB_TOKEN }}

      # Secret Scan
      - name: üîê Secret Scan (detect-secrets)
        run: |
          echo "üîç Executando varredura de segredos..."
          if [ -f ./scripts/ci-git-secret-scan.sh ]; then
            chmod +x ./scripts/ci-git-secret-scan.sh
            ./scripts/ci-git-secret-scan.sh
          else
            echo "‚ö†Ô∏è Script de secret scan N√ÉO encontrado em ./scripts/ci-git-secret-scan.sh"
            exit 1
          fi

      # Debug do repo
      - name: üìÇ Debug ‚Äì Estrutura de pastas
        run: |
          echo "PWD: $(pwd)"
          echo "Listando /packages..."
          ls -la packages || echo "‚ùå pasta 'packages' n√£o encontrada"
          echo "Listando raiz (2 n√≠veis)..."
          ls -la | sed -n '1,200p'

      # Setup Flutter/Dart
      - name: ‚öôÔ∏è Configurar Ambiente (Flutter, Dart, PATH)
        uses: ./.github/actions/setup-env

      # Limpeza autom√°tica quando a vers√£o do Flutter muda
      - name: üßπ Limpar artefatos se vers√£o do Flutter mudou
        if: env.FLUTTER_VERSION != ''
        run: |
          echo "üåÄ Vers√£o atual do Flutter: $FLUTTER_VERSION"
          
          CACHE_META="$HOME/.pub-cache/flutter-version.txt"

          # Se arquivo com vers√£o n√£o existir ‚Üí nova instala√ß√£o
          if [ ! -f "$CACHE_META" ]; then
            echo "Nenhum registro de vers√£o pr√©via ‚Äî criando..."
            echo "$FLUTTER_VERSION" > "$CACHE_META"
          else
            OLD_VERSION=$(cat "$CACHE_META")
            echo "üì¶ Vers√£o cache anterior: $OLD_VERSION"

            if [ "$OLD_VERSION" != "$FLUTTER_VERSION" ]; then
              echo "‚ö†Ô∏è Flutter mudou ‚Üí Limpando .dart_tool e cache hosted"
              rm -rf .dart_tool || true
              rm -rf $HOME/.pub-cache/hosted || true
              echo "$FLUTTER_VERSION" > "$CACHE_META"
            else
              echo "‚úî Vers√£o igual ‚Äî mantendo cache"
            fi
          fi

      # Cache com vers√£o do Flutter
      - name: üíæ Restaurar/Criar Cache de Depend√™ncias
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            ~/.pub-cache
            .dart_tool/
          key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-pub-

      # Verifica√ß√£o Melos
      - name: üìå Verificar melos.yaml e listar pacotes
        run: |
          if [ -f ./melos.yaml ]; then
            echo "melos.yaml encontrado!"
            dart pub global activate melos
            echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
            melos list || true
          else
            echo "‚ùå melos.yaml N√ÉO encontrado!"
            ls -la
            exit 1
          fi

      # Melos Bootstrap
      - name: üì¶ Melos Bootstrap
        working-directory: ${{ github.workspace }}
        run: |
          dart pub global activate melos
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          melos bootstrap

  # -------------------
  # 2Ô∏è‚É£ Formata√ß√£o + An√°lise Est√°tica (R√°pido ‚Äî PRs)
  # -------------------
  analise_e_formato:
    needs: setup
    if: ${{ !startsWith(github.head_ref, 'dependabot/') }}
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout (r√°pido) 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup-env (mesmo ambiente do job base)
        uses: ./.github/actions/setup-env

      - name: üíæ Restaurar Cache (novamente, para esse job)
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool/
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}

      - name: üì¶ Melos Bootstrap (Garantia de Links)
        working-directory: ${{ github.workspace }}
        run: melos bootstrap

      - name: üìê Verificar Formata√ß√£o (CR√çTICO)
        # Verifica√ß√£o n√£o altera c√≥digo; falha bloqueante para PRs
        run: melos run format:check

      - name: üßê An√°lise Est√°tica (CR√çTICO)
        # dart/flutter analyze + regras do time. Relacionado a seguran√ßas est√°ticas.
        # Recomenda√ß√£o MASVS/OWASP Mobile: an√°lise est√°tica detecta m√° configura√ß√£o TLS, uso inseguro de APIs, valida√ß√£o de entrada, etc.
        run: melos run analyze

      - name: üìù Report ‚Äî Depend√™ncias desatualizadas (informativo)
        # Informe ao time sobre pacotes desatualizados ‚Äî n√£o bloqueante.
        run: |
          echo "Relat√≥rio de depend√™ncias desatualizadas (informativo)"
          melos exec -- dart pub outdated || true

  # -------------------
  # 3Ô∏è‚É£ Testes Unit√°rios + Cobertura (Roda em paralelo ao 2)
  # -------------------
  testes_unidade:
    needs: setup
    if: ${{ !startsWith(github.head_ref, 'dependabot/') }}
    runs-on: ubuntu-latest
    outputs:
      coverage-path: coverage/html
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup-env
        uses: ./.github/actions/setup-env

      - name: üíæ Restaurar Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool/
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}

      - name: üõ†Ô∏è Instalar lcov (para gerar relat√≥rios HTML)
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: üì¶ Melos Bootstrap (Garantia de Links)
        working-directory: ${{ github.workspace }}
        run: melos bootstrap

      - name: üß™ Executar Testes Unit√°rios e Cobertura (Melos)
        # Executa testes de todos os packages que tiverem script `test` no melos.yaml
        run: melos run test

      - name: üìÇ Combinar Cobertura (LCOV)
        run: |
          mkdir -p coverage
          find . -name "lcov.info" | while read -r file; do
            cat "$file" >> coverage/combined.lcov.info
          done

      - name: üîÑ Corrigir Caminhos do LCOV (Monorepo)
        # Ajusta caminhos gerados pelo runner para que o relat√≥rio HTML funcione
        run: |
          mkdir -p coverage
          sed -E 's|SF:/home/runner/work/[^/]*/[^/]*/||g' coverage/combined.lcov.info > coverage/lcov_tmp.info
          # Ajuste por app espec√≠fico ‚Äî personalize conforme estrutura do seu monorepo
          if grep -q "SF:lib/" coverage/lcov_tmp.info; then
            echo "üîß Ajustando caminhos relativos para monorepo..."
            sed -E 's|SF:lib/|SF:apps/appbank/lib/|g' coverage/lcov_tmp.info > coverage/lcov_formatted.info || mv coverage/lcov_tmp.info coverage/lcov_formatted.info
          else
            mv coverage/lcov_tmp.info coverage/lcov_formatted.info
          fi

      - name: üìä Gerar Relat√≥rio HTML (LCOV -> HTML)
        run: genhtml coverage/lcov_formatted.info -o coverage/html --ignore-errors source --synthesize-missing

      - name: ‚¨ÜÔ∏è Upload do Relat√≥rio HTML (Artefato)
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-cobertura-flutter
          path: coverage/html
          retention-days: 7

      - name: üßæ Publicar cobertura (opcional)
        # Aqui voc√™ poderia postar a cobertura em um servi√ßo (Codecov/Coveralls) se desejar.
        run: echo "Cobertura gerada em coverage/html"

  # -------------------
  # 4Ô∏è‚É£ Build de verifica√ß√£o (Somente no Merge/Push para branches principais)
  # -------------------
  verificacao_build:
    needs: [analise_e_formato, testes_unidade]
    runs-on: ubuntu-latest
    # Executa somente quando √© push na main (ou PR cujo base √© main) ‚Äî evita builds desnecess√°rios
    if: >
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'))
      ||
      (github.event_name == 'pull_request' && (github.base_ref == 'main' || github.base_ref == 'develop'))

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup-env
        uses: ./.github/actions/setup-env

      - name: üíæ Restaurar Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool/
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}

      - name: üì¶ Melos Bootstrap (Garantia de Links)
        working-directory: ${{ github.workspace }}
        run: melos bootstrap
        

      # ======================================================
      # üîê OSV API SCANNER ‚Äî Flutter/Dart/Melos (YAML-SAFE / FINAL)
      # ======================================================

      #OPCIONAL - Quase nenhum vulnerabilidade foi encontrada e registrada no OSC para pub
      #O OSV abaixo e para testes ou para aplica√ß√µes que tem n√≠veis de seguran√ßa elevado e n√£o querem outra forma de controle.

      #üîê Seguran√ßa de Depend√™ncias (Flutter/Dart) com OSV.dev
      # Este projeto utiliza o OSV.dev (Open Source Vulnerabilities) ‚Äî a base oficial de vulnerabilidades mantida pela Google ‚Äî para realizar An√°lise de Composi√ß√£o de Software (SCA) no ecossistema Flutter/Dart, substituindo ferramentas como Snyk, que atualmente n√£o oferecem suporte oficial ao gerenciador de pacotes pub.
      # Por que OSV?
      # √â a base de vulnerabilidades utilizada por Google, Android, Rust, Python e diversos ecossistemas oficiais.
      # Disponibiliza uma API p√∫blica, gratuita e aberta, sem necessidade de tokens.
      # Suporta Flutter/Dart via ecossistema ‚ÄúPub‚Äù, permitindo varredura direta de depend√™ncias listadas nos pubspec.lock.
      # N√£o requer instala√ß√£o de bin√°rios adicionais ou ferramentas externas.
      # üîç O que exatamente est√° sendo analisado?
      # O pipeline extrai automaticamente todos os arquivos pubspec.lock do workspace (Melos) e envia a lista de depend√™ncias para o OSV.dev, identificando vulnerabilidades relacionadas a:
      # Depend√™ncias diretas (dependencies)
      # Depend√™ncias transitivas (transitive dependencies)
      # Vers√µes inseguras ou com CVE atribu√≠dos
      # Libraries Flutter/Dart do Pub.dev
      # Bibliotecas nativas integradas ao app via plugins

      - name: Inicio da Analise do OSV API SCANNER 
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo snap install yq

      # -----------------------------
      # Localizar todos os pubspec.lock
      # -----------------------------
      - name: Locate pubspec.lock files
        run: |
          find . -name "pubspec.lock" > lockfiles.txt
          sort -u lockfiles.txt -o lockfiles.txt

          echo "üì¶ pubspec.lock encontrados:"
          cat lockfiles.txt

      # -----------------------------
      # Preparar payload OSV.dev (sem HEREDOC)
      # -----------------------------
      - name: Prepare OSV payload
        run: |
          echo '{"queries":[' > osv_queries.json

          while read -r LOCK; do
            echo "üîç Parsing $LOCK"

            JSON=$(yq -o=json '.' "$LOCK")

            echo "$JSON" \
            | jq -c '.packages | to_entries[]' \
            | while read -r ENTRY; do
                NAME=$(echo "$ENTRY" | jq -r '.key')
                VERSION=$(echo "$ENTRY" | jq -r '.value.version')

                # Ignorar SDK, git e paths
                if [[ "$VERSION" == *"from sdk"* ]]; then continue; fi
                if echo "$ENTRY" | grep -q '"source":"git"'; then continue; fi
                if echo "$ENTRY" | grep -q '"source":"path"'; then continue; fi

                # Adiciona item SEMPRE com v√≠rgula no final
                printf '{"package":{"name":"%s","ecosystem":"Pub"},"version":"%s"},' \
                  "$NAME" "$VERSION" >> osv_queries.json
              done

          done < lockfiles.txt

          # Remover a √∫ltima v√≠rgula
          sed -i 's/,$//' osv_queries.json

          # Fechar JSON
          echo "]}" >> osv_queries.json

          echo "üìù Payload OSV preparado:"
          cat osv_queries.json


      # -----------------------------
      # Consultar API OSV.dev
      # -----------------------------
      - name: Query OSV API
        run: |
          curl -s -X POST "https://api.osv.dev/v1/querybatch" \
            -H "Content-Type: application/json" \
            -d @osv_queries.json > osv_response.json

          echo "üìÑ OSV API response:"
          cat osv_response.json

      - name: Generate Markdown Report
        run: |
          echo "# üîç OSV.dev Vulnerability Report" > osv_report.md
          echo "" >> osv_report.md
          echo "Gerado automaticamente pelo pipeline CI/CD." >> osv_report.md
          echo "" >> osv_report.md

          echo "## üìÑ Payload enviado (osv_queries.json)" >> osv_report.md
          echo '```json' >> osv_report.md
          cat osv_queries.json >> osv_report.md
          echo '```' >> osv_report.md
          echo "" >> osv_report.md

          echo "## üì• Resposta da API (osv_response.json)" >> osv_report.md
          echo '```json' >> osv_report.md
          cat osv_response.json >> osv_report.md
          echo '```' >> osv_report.md
          echo "" >> osv_report.md

          echo "## üìä Resultado resumido" >> osv_report.md
          echo "" >> osv_report.md

          TOTAL=$(jq '.results | length' osv_response.json)
          AFFECTED=$(jq '[.results[] | select(.vulns != null)] | length' osv_response.json)
          CRIT=$(jq '[.results[]?.vulns[]? | select(.severity=="CRITICAL" or .severity=="HIGH")] | length' osv_response.json)
          HIGH=$(jq '[.results[]?.vulns[]? | select(.severity=="HIGH")] | length' osv_response.json)
          MED=$(jq '[.results[]?.vulns[]? | select(.severity=="MEDIUM")] | length' osv_response.json)
          LOW=$(jq '[.results[]?.vulns[]? | select(.severity=="LOW")] | length' osv_response.json)

          {
            echo "**Pacotes analisados:** $TOTAL"
            echo "**Pacotes afetados:** $AFFECTED"
            echo ""
            echo "| Severidade       | Quantidade |"
            echo "|------------------|------------|"
            echo "| üü• Critical/High | $CRIT      |"
            echo "| üüß High          | $HIGH      |"
            echo "| üü® Medium        | $MED       |"
            echo "| üü© Low           | $LOW       |"
            echo ""
            echo "## üìå Vulnerabilidades encontradas"

            VULNS=$(jq -r '
              .results[]
              | select(.vulns != null)
              | .vulns[]
              | "- ID: \(.id) - Severity: \(.severity) - Affected: \(.affected[]?.package?.name // "")"
            ' osv_response.json)

            if [ -z "$VULNS" ]; then
              echo "Nenhuma vulnerabilidade encontrada."
            else
              echo "$VULNS"
            fi
          } >> osv_report.md


      # -----------------------------
      # Upload dos artefatos (reten√ß√£o de 2 dias)
      # -----------------------------
      - name: Upload OSV Payload
        uses: actions/upload-artifact@v4
        with:
          name: osv_payload
          path: osv_queries.json
          retention-days: 2

      - name: Upload OSV Response
        uses: actions/upload-artifact@v4
        with:
          name: osv_response
          path: osv_response.json
          retention-days: 2

      - name: Upload OSV Markdown Report
        uses: actions/upload-artifact@v4
        with:
          name: osv_report_markdown
          path: osv_report.md
          retention-days: 2



      # -----------------------------
      # Falhar pipeline se CRITICAL/HIGH
      # -----------------------------
      - name: Fail on Critical
        run: |
          if [ "${{ steps.osv-summary.outputs.critical_count }}" -gt 0 ]; then
            echo "‚ùå Build bloqueado devido a vulnerabilidades severas."
            exit 1
          fi

          echo "‚úî Nenhuma vulnerabilidade grave detectada."


      - name: ‚úÖ Build de Verifica√ß√£o (Debug)
        # Build para valida√ß√£o (por exemplo: flutter build apk --debug)
        # Mantemos como melos run build_app para n√£o quebrar scripts existentes.
        run: melos run build_app

     