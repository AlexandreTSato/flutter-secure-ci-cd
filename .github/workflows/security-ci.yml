name: CI - SECURITY

# ---------------------------------------------------------------------------
# Este workflow executa uma pipeline de seguranÃ§a completa para aplicativos 
# mobile Flutter, incluindo: SAST, SCA, Secret Scan, Binary Scan e MASVS.
#
# Compatibilidade com OWASP:
# - Mobile Top 10: M1, M2, M3, M8, M9, M10
# - MASVS: L2, MSTG-CODE, MSTG-PLATFORM, MSTG-STORAGE, MSTG-CRYPTO
#
# Este pipeline NÃƒO faz build â€” espera que o CI de qualidade gere APK/AAB
# quando necessÃ¡rio para os scanners binÃ¡rios.
# ---------------------------------------------------------------------------

on:
  pull_request:
    branches: [ develop ]
  push:
    branches: [ develop ]

permissions:
  contents: read
  security-events: read

jobs:
  security-ci:    
    name: ğŸ” Security Validation Pipeline
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.head_ref, 'dependabot/') }}
    timeout-minutes: 10

    steps:
      # ---------------------------------------------------------------------------
      # 1) CHECKOUT
      # ---------------------------------------------------------------------------
      - name: â¬‡ï¸ Checkout cÃ³digo fonte
        uses: actions/checkout@v6
        with:
          # Obs: shallow clone Ã© aceitÃ¡vel aqui (1 commit)
          fetch-depth: 1

      # ---------------------------------------------------------------------------
      # 2) CACHES (Python, Trivy)
      # ---------------------------------------------------------------------------
      - name: âš¡ Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', 'pyproject.toml', 'security/**', 'scripts/**') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: âš¡ Cache Trivy vulnerability DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-${{ runner.os }}-${{ github.run_id }}
          restore-keys: trivy-${{ runner.os }}-

      # ---------------------------------------------------------------------------
      # 3) SECRET SCAN (M9 â€“ Extraneous Functionality, M10 â€“ Improper Platform Usage)
      # detect-secrets + gitleaks
      # ---------------------------------------------------------------------------
      - name: ğŸ§© Instalar ferramentas de secret scanning
        run: |
          python3 -m pip install --upgrade pip
          pip install detect-secrets jq
          if ! command -v gitleaks &> /dev/null; then
            echo "â¬‡ï¸ Instalando Gitleaks..."
            curl -sSL https://github.com/zricethezav/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz \
              | tar -xz -C /usr/local/bin gitleaks
          else
            echo "âœ… Gitleaks disponÃ­vel no runner"
          fi

      - name: ğŸ” Scan de secrets (prÃ©-commit + git-history)
        id: secrets-scan
        run: |
          set -e
          chmod +x scripts/ci-git-secret-scan.sh
          ./scripts/ci-git-secret-scan.sh
          echo "status=âœ… PASSED" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------------------------
      # 4) MobSFScan â€” SAST + MASVS
      # ---------------------------------------------------------------------------
      # MASVS: M1, M2, M3, M8, M9, M10 (SAST + Config checks)
      # ---------------------------------------------------------------------------
      - name: ğŸ”§ Garantir que o script de SSL Pinning check estÃ¡ disponÃ­vel
        run: |
          if [ -f scripts/check-pinning-and-mobsf.sh ]; then
            chmod +x scripts/check-pinning-and-mobsf.sh
          else
            echo "âŒ Script nÃ£o encontrado: scripts/check-pinning-and-mobsf.sh"
            exit 1
          fi

      - name: âš¡ Cache MobSFScan
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: mobsfscan-${{ runner.os }}-${{ hashFiles('security/mobsfscan-config.yaml') }}
          restore-keys: mobsfscan-${{ runner.os }}-

      - name: ğŸ§© Instalar MobSFScan
        run: |
          python3 -m pip install --upgrade pip
          pip install mobsfscan jq

      - name: ğŸ§  Rodar MobSFScan (MASVS Ruleset)
        id: mobsf
        run: |
          set -e
          echo "ğŸ Rodando MobSFScan (MASVS)"

          mobsfscan --json \
            --config security/mobsfscan-config.yaml \
            . > mobsfscan-report.json 2> mobsfscan-stderr.log || true

          # Debug parcial
          echo "Preview do relatÃ³rio:"
          head -n 40 mobsfscan-report.json || true

          # Gate customizado
          chmod +x scripts/mobsf-gate.sh
          ./scripts/mobsf-gate.sh

          echo "status=âœ… PASSED" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------------------------
      # 5) Binary Secrets Scan (APK/AAB) â€“ MASVS (extraneous functionality)
      # ---------------------------------------------------------------------------
      - name: ğŸ” Binary Scan (APK/AAB) â€” procura segredos embutidos
        id: binary-scan
        if: always()
        run: |
          chmod +x scripts/scan-binaries-for-secrets.sh
          ARTIFACTS=$(find apps -type f \( -name "*.apk" -o -name "*.aab" \) || true)

          if [ -z "$ARTIFACTS" ]; then
            echo "âš ï¸ Nenhum APK ou AAB encontrado para escanear."
          else
            ./scripts/scan-binaries-for-secrets.sh $ARTIFACTS
          fi

          echo "status=âœ… PASSED" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------------------------
      # 6) Debug automÃ¡tico do MobSF em caso de falha
      # ---------------------------------------------------------------------------
      - name: ğŸ” Debug MobSF Output (on fail)
        if: failure()
        run: |
          echo "---- mobsfscan-report.json ----"
          cat mobsfscan-report.json || echo "âš ï¸ Report nÃ£o encontrado."
          echo "---- stderr ----"
          cat mobsfscan-stderr.log || echo "âš ï¸ Sem stderr."

      # ---------------------------------------------------------------------------
      # 7) Upload de relatÃ³rios MobSF/Mobility
      # ---------------------------------------------------------------------------
      - name: ğŸ“¤ Upload MobSF reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobsfscan-report
          path: |
            mobsfscan-report.json
            mobsfscan-stderr.log

      # ---------------------------------------------------------------------------
      # 8) GITLEAKS (somente CI â€” SARIF)
      # ---------------------------------------------------------------------------
      - name: ğŸ” Run Gitleaks (SARIF)
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: false
        with:
          args: detect --no-git --redact \
            --report-format=sarif \
            --report-path=results.sarif \
            --log-level=error

      - name: Registrar status gitleaks
        if: always()
        run: |
          if [ "${{ steps.gitleaks.outcome }}" = "success" ]; then
            echo "status=âœ… PASSED" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ FAILED" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------------------------
      # 9) TRIVY â€” SCA (M8 â€“ Insecure Dependencies)
      # ---------------------------------------------------------------------------
      - name: ğŸ§© Instalar Trivy (SCA)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release jq
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" \
            | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y
          sudo apt-get install -y trivy

      - name: ğŸ§© Rodar Trivy (HIGH/CRITICAL enforcement)
        id: trivy
        continue-on-error: false
        run: |
          echo "ğŸ” Trivy SCA â€” Buscando vulnerabilidades HIGH/CRITICAL"
          trivy fs . --cache-dir ~/.cache/trivy \
            --security-checks vuln \
            --severity HIGH,CRITICAL \
            --ignore-unfixed \
            --format json \
            -o trivy-report.json \
            --exit-code 1 || true

          VULN_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' trivy-report.json || echo "0")

          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "âŒ Trivy detectou $VULN_COUNT vulnerabilidades HIGH/CRITICAL"
            echo "status=âŒ FAILED" >> $GITHUB_OUTPUT
            echo "1" > trivy-failed.flag
          else
            echo "âœ… Sem vulnerabilidades HIGH/CRITICAL"
            echo "status=âœ… PASSED" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¤ Upload Trivy report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report.json

      # ---------------------------------------------------------------------------
      # 10) Dependabot Enforcement (SCA)
      # ---------------------------------------------------------------------------
      - name: ğŸ”§ Instalar GitHub CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gh jq

      - name: ğŸ” Verificar alertas Dependabot (SCA)
        id: dependabot
        env:
          GH_TOKEN: ${{ secrets.GH_DEPENDABOT_TOKEN || secrets.GITHUB_TOKEN }}
        continue-on-error: true
        run: |
          gh api /repos/${{ github.repository }}/dependabot/alerts --paginate > dependabot-alerts.json || echo "[]"

          HIGH=$(jq '[.[] | select(.state=="open" and .security_advisory.severity=="HIGH")] | length' dependabot-alerts.json)
          CRIT=$(jq '[.[] | select(.state=="open" and .security_advisory.severity=="CRITICAL")] | length' dependabot-alerts.json)
          TOTAL=$((HIGH + CRIT))

          if [ "$TOTAL" -gt 0 ]; then
            echo "âŒ Dependabot encontrou $TOTAL vulnerabilidades HIGH/CRITICAL"
            echo "status=âŒ FAILED" >> $GITHUB_OUTPUT
            echo "1" > dependabot-failed.flag
          else
            echo "âœ… Dependabot sem vulnerabilidades crÃ­ticas"
            echo "status=âœ… PASSED" >> $GITHUB_OUTPUT
          fi          

      











      # ---------------------------------------------------------------------------
      # 11) CODEQL (Android Nativo â€” MSTG-PLATFORM)
      # ---------------------------------------------------------------------------
      - name: ğŸ”§ CodeQL â€” InicializaÃ§Ã£o
        if: ${{ hashFiles('android/app/src/**/*.kt', 'android/app/src/**/*.java') != '' }}
        uses: github/codeql-action/init@v3
        with:
          languages: java
          queries: +security-and-quality

      - name: ğŸ§  Build Android (para CodeQL)
        if: ${{ hashFiles('android/app/src/**/*.kt', 'android/app/src/**/*.java') != '' }}
        run: |
          cd android
          ./gradlew assembleDebug || echo "âš ï¸ Build falhou, anÃ¡lise continua."

      - name: ğŸ§© Rodar CodeQL
        if: ${{ hashFiles('android/app/src/**/*.kt', 'android/app/src/**/*.java') != '' }}
        uses: github/codeql-action/analyze@v3
        continue-on-error: true

      # ---------------------------------------------------------------------------
      # 12) RelatÃ³rio Final â€” FÃ¡cil leitura para PRs
      # ---------------------------------------------------------------------------
      - name: ğŸ“Š Security Summary
        if: always()
        run: |
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ” SECURITY SUMMARY"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          printf "ğŸ§  Secrets (detect-secrets): %s\n" "${{ steps.secrets-scan.outputs.status || 'N/A' }}"
          printf "ğŸ” Gitleaks CI:              %s\n" "${{ steps.gitleaks.outputs.status || 'N/A' }}"
          printf "ğŸ“± MobSFScan (MASVS):        %s\n" "${{ steps.mobsf.outputs.status || 'N/A' }}"
          printf "ğŸ§® Binary Secrets Scan:      %s\n" "${{ steps.binary-scan.outputs.status || 'N/A' }}"
          printf "ğŸ§© Trivy (SCA):              %s\n" "${{ steps.trivy.outputs.status || 'N/A' }}"
          printf "ğŸ™ Dependabot Alerts:        %s\n" "${{ steps.dependabot.outputs.status || 'N/A' }}"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

      - name: ğŸ§¾ Resumo Final do Pipeline de SeguranÃ§a
        if: always()
        run: |
          {
            echo "# ğŸ” RESUMO FINAL - SECURITY PIPELINE"
            echo ""
            echo "## âœ… Etapas Executadas"
            echo "- ğŸ§  Secret Scan (detect-secrets)"
            echo "- ğŸ” Gitleaks"
            echo "- ğŸ“± MobSFScan (SAST/MASVS)"
            echo "- ğŸ§® Binary Secrets Scan (APK/AAB)"
            echo "- ğŸ§© Trivy (SCA)"
            echo "- ğŸ™ Dependabot Alerts"
            echo "- ğŸ§ª CodeQL (Android nativo, se presente)"
            echo ""
            # Determinar status agregado (falha se flags de dependabot/trivy existirem ou algum step marcou FAILED)
            TRIVY_FLAG=0
            DEP_FLAG=0
            [ -f trivy-failed.flag ] && TRIVY_FLAG=1
            [ -f dependabot-failed.flag ] && DEP_FLAG=1

            FAILED=0
            for S in "${{ steps.secrets-scan.outputs.status }}" \
                     "${{ steps.gitleaks.outputs.status }}" \
                     "${{ steps.mobsf.outputs.status }}" \
                     "${{ steps.binary-scan.outputs.status }}" \
                     "${{ steps.trivy.outputs.status }}" \
                     "${{ steps.dependabot.outputs.status }}"; do
              echo "$S" | grep -q "FAILED" && FAILED=1
            done

            if [ $TRIVY_FLAG -eq 1 ] || [ $DEP_FLAG -eq 1 ] || [ $FAILED -eq 1 ]; then
              echo "## ğŸ”´ Status Final: **FALHA NA PIPELINE DE SEGURANÃ‡A**"
              echo "![fail](https://img.shields.io/badge/Security-Falhou-red?style=for-the-badge&logo=github)"
            else
              echo "## ğŸŸ¢ Status Final: **SUCESSO TOTAL**"
              echo "![success](https://img.shields.io/badge/Security-Sucesso-brightgreen?style=for-the-badge&logo=github)"
            fi
            echo ""
            echo "## ğŸ“Œ Contexto"
            echo "- Branch: ${{ github.ref_name }}"
            echo "- Actor: ${{ github.actor }}"
            echo "- Workflow: ${{ github.workflow }}"
            echo ""
            echo "## ğŸ“ˆ Detalhes"
            echo "- Secrets: ${{ steps.secrets-scan.outputs.status || 'N/A' }}"
            echo "- Gitleaks: ${{ steps.gitleaks.outputs.status || 'N/A' }}"
            echo "- MobSFScan: ${{ steps.mobsf.outputs.status || 'N/A' }}"
            echo "- Binary Scan: ${{ steps.binary-scan.outputs.status || 'N/A' }}"
            echo "- Trivy: ${{ steps.trivy.outputs.status || 'N/A' }}"
            echo "- Dependabot: ${{ steps.dependabot.outputs.status || 'N/A' }}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: ğŸš¨ ENFORCEMENT â€” Se falhar em SCA, bloquear PR/merge
        if: always()
        run: |
          TRIVY=0
            DEP=0

            if [ -f trivy-failed.flag ]; then TRIVY=1; fi
            if [ -f dependabot-failed.flag ]; then DEP=1; fi

            if [ "$TRIVY" -eq 1 ] || [ "$DEP" -eq 1 ]; then
              echo "ğŸš« SeguranÃ§a CRÃTICA â€” bloqueando."
              exit 1
            fi

            echo "âœ… Nenhuma vulnerabilidade crÃ­tica encontrada."
