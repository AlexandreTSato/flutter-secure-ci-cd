name: DAST

on:
  workflow_call:
    inputs:
      apk_artifact_name:
        required: true
        type: string
      target_package_name:
        required: true
        type: string

concurrency:
  group: cd-android-dast-pinning-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate_pinning:
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.head_ref, 'dependabot/') }}
    timeout-minutes: 25

    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.apk_artifact_name }}
          path: dast      

      - name: âš™ï¸ Instalar ferramentas DAST
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install mitmproxy frida-tools objection
          sudo apt-get update -y
          sudo apt-get install -y openssl

      - name: ðŸŒ Iniciar mitmdump (Proxy MITM)
        shell: bash
        run: |
          set -e
          nohup mitmdump -q --listen-host 127.0.0.1 -p 8080 --set block_global=false > mitm.log 2>&1 &
          echo "PROXY_PID=$!" >> "$GITHUB_ENV"
          sleep 5
          ls -la ~/.mitmproxy || true

      - name: ðŸ“ Criar script DAST
        shell: bash
        run: |
          set -e
          mkdir -p scripts
          cat > scripts/dast-emulator-run.sh <<'EOF'
          
          #!/usr/bin/env bash
          set -euo pipefail

          TARGET_PACKAGE="${TARGET_PACKAGE:?TARGET_PACKAGE vazio}"
          APK_DIR="${APK_DIR:-dast}"
          MITM_LOG="${MITM_LOG:-mitm.log}"

          echo "[DAST] InÃ­cio pÃ³s-boot. Listando devices:"
          adb devices

          # Garantir que o emulador estÃ¡ em estado 'device'
          EMULATOR_ID="$(adb devices | awk '/emulator-/{print $1; exit}')"
          if [ -z "${EMULATOR_ID:-}" ]; then
            echo "::error:: Nenhum emulator-* listado"
            exit 1
          fi
          echo "[DAST] DEVICE=$EMULATOR_ID"

          # Verificar boot (defensivo)
          for i in $(seq 1 60); do
            if adb -s "$EMULATOR_ID" shell getprop sys.boot_completed 2>/dev/null | grep -q 1; then
              break
            fi
            sleep 2
          done

          # Desativar animaÃ§Ãµes
          for s in window_animation_scale transition_animation_scale animator_duration_scale; do
            adb -s "$EMULATOR_ID" shell settings put global "$s" 0 || true
          done
          adb -s "$EMULATOR_ID" shell input keyevent 82 || true

          # Localizar APK
          APK_FILE="$(find "$APK_DIR" -maxdepth 2 -type f -name '*.apk' | head -n1 || true)"
          if [ -z "${APK_FILE:-}" ]; then
            echo "::error:: APK nÃ£o encontrado em $APK_DIR"
            ls -R "$APK_DIR" || true
            exit 1
          fi
          echo "[DAST] APK=$APK_FILE"          

          # Instalar com retry
          for i in 1 2 3; do
            if adb -s "$EMULATOR_ID" install -r "$APK_FILE"; then
              break
            fi
            echo "[DAST] Retry install ($i)..."
            sleep 5
            [ "$i" = "3" ] && { echo "::error:: Falha install APK"; exit 1; }
          done

          # Proxy (best-effort)
          adb -s "$EMULATOR_ID" shell settings put global http_proxy 10.0.2.2:8080 || true

          # TrÃ¡fego
          adb -s "$EMULATOR_ID" shell monkey -p "$TARGET_PACKAGE" 80 || true
          sleep 30

          tail -n 80 "$MITM_LOG" || true

          PINNING_RESULT="PASS"
          if grep -E "HTTP/[0-9]|CONNECT" "$MITM_LOG" >/dev/null 2>&1; then
            echo "::error:: âŒ PINNING FALHOU â€” trÃ¡fego interceptado"
            PINNING_RESULT="FAIL"
          fi

          if [ "$PINNING_RESULT" = "PASS" ]; then
            echo "[DAST] Tentando bypass (Objection 60s)..."
            timeout 60s objection explore --startup-command "android sslpinning disable" --target "$TARGET_PACKAGE" || true
            sleep 5
            if grep -E "HTTP/[0-9]|CONNECT" "$MITM_LOG" >/dev/null 2>&1; then
              echo "::error:: âŒ Bypass SSL Pinning bem-sucedido"
              PINNING_RESULT="BYPASS_FAIL"
            fi
          fi

          echo "[DAST] Resultado: $PINNING_RESULT"
          case "$PINNING_RESULT" in
            FAIL|BYPASS_FAIL) exit 1 ;;
            *) exit 0 ;;
          esac

      - name: ðŸš€ Emulador + DAST (SSL Pinning)
        id: emulator_and_tests
        uses: reactivecircus/android-emulator-runner@v2
        env:
          TARGET_PACKAGE: ${{ inputs.target_package_name }}
          APK_DIR: dast
          MITM_LOG: mitm.log
        with:
          api-level: 29
          target: google_apis
          arch: x86_64
          ram-size: 2048
          heap-size: 256
          cores: 2
          avd-name: mitm-lite
          force-avd-creation: true
          disable-animations: true
          emulator-boot-timeout: 900
          emulator-options: >
            -no-window -no-audio -no-boot-anim -no-metrics
            -no-snapshot -gpu swiftshader_indirect -accel off
          script: bash scripts/dast-emulator-run.sh

      - name: ðŸ“¦ Upload logs DAST
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: dast-logs
          path: mitm.log
          if-no-files-found: warn
          retention-days: 1

      - name: ðŸ›‘ Encerrar Proxy MITM
        if: always()
        run: |
          kill "$PROXY_PID" || true
          echo "Proxy finalizado."
