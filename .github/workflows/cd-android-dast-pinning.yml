name: DAST - SSL Pinning Validation

on:
  workflow_call:
    inputs:
      apk_artifact_name:
        required: true
        type: string
      target_package_name:
        required: true
        type: string

jobs:
  validate_pinning:
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.head_ref, 'dependabot/') }}
    timeout-minutes: 15 # Aumentado para acomodar o setup do certificado

    steps:
      # ... (Passos 1 a 3: Checkout, Download APK, Instalar e Iniciar mitmdump)
      
      - name: ‚öôÔ∏è Instalar Python Tools para DAST
        run: |
          pip install --upgrade pip
          pip install mitmproxy frida-tools objection # Inclui Frida e Objection

      - name: ‚¨áÔ∏è Iniciar mitmdump e Gerar Certificado
        run: |
          # Inicia em background e gera o certificado raiz do mitmproxy
          nohup mitmdump -q --listen-host 127.0.0.1 -p 8080 --set block_global=false > mitm.log 2>&1 &
          echo "PROXY_PID=$!" >> $GITHUB_ENV
          sleep 5 
          # mitmproxy armazena o certificado em ~/.mitmproxy/mitmproxy-ca-cert.cer

      # ----------------------------------------------------------
      # 4. EMULADOR OTIMIZADO PARA GITHUB ACTIONS (ULTRA-FAST BOOT)
      # ----------------------------------------------------------
      - name: üöÄ Start Ultra-Fast Emulator (MITM Compatible)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 24                   # ‚≠ê Mais r√°pido e leve suportado
          target: default                 # ‚≠ê MUITO mais leve que google_apis
          arch: x86_64
          ram-size: 1024
          heap-size: 192
          cores: 1
          avd-name: mitm-lite
          force-avd-creation: true
          disable-animations: true
          emulator-boot-timeout: 300

          emulator-options: >
            -no-window
            -no-audio
            -no-boot-anim
            -gpu swiftshader_indirect
            -writable-system

          script: |
            echo "‚è≥ Stabilizing emulator..."
            sleep 8
            adb devices
            echo "Emulator ready."

      # ----------------------------------------------------------
      # 5. CONFIGURA√á√ÉO MITM (Certificado Root + Proxy + Instala√ß√£o APK)
      # ----------------------------------------------------------
      - name: üîê Configurar Certificado MITM + Proxy + APK
        run: |
          set -euo pipefail

          echo "üîé Aguardando ADB..."
          adb wait-for-device

          echo "üîê Elevando permiss√µes (root)‚Ä¶"
          adb root
          sleep 4
          adb wait-for-device
          adb remount

          echo "üì• Copiando certificado MITM..."
          adb push ~/.mitmproxy/mitmproxy-ca-cert.cer /sdcard/mitmproxy-ca-cert.cer

          CERT_HASH=$(openssl x509 -inform DER -in ~/.mitmproxy/mitmproxy-ca-cert.cer | openssl x509 -hash -noout)
          CERT_NAME="${CERT_HASH}.0"

          echo "üíæ Instalando certificado em /system/etc/security/cacerts/$CERT_NAME..."
          adb shell cp /sdcard/mitmproxy-ca-cert.cer /system/etc/security/cacerts/$CERT_NAME
          adb shell chmod 644 /system/etc/security/cacerts/$CERT_NAME

          echo "üåê Configurando proxy global 10.0.2.2:8080..."
          adb shell settings put global http_proxy 10.0.2.2:8080

          echo "üì¶ Instalando APK..."
          APK=$(find dast -name "*.apk" | head -n 1)
          adb install -r "$APK"

      # ----------------------------------------------------------
      # 6. TESTES + GERA√á√ÉO DE TR√ÅFEGO
      # ----------------------------------------------------------
      - name: üêµ Executar Monkey / Gera√ß√£o de Tr√°fego
        run: |
          echo "üöÄ Iniciando app e Monkey..."
          adb shell monkey -p ${{ inputs.target_package_name }} 1

          echo "‚è≥ Aguardando tr√°fego (30s)..."
          sleep 30


      # ----------------------------------------------------------
      # 5. VALIDAR LOGS MITM (Verifica√ß√£o Cl√°ssica)
      # ----------------------------------------------------------
      - name: üîç Validar logs MITM (SSL Pinning Cl√°ssico)
        id: mitm_check
        run: |
          # ... (C√≥digo original de valida√ß√£o aqui)
          tail -n 100 mitm.log || true

          if grep -E "HTTP/1" mitm.log >/dev/null 2>&1; then
            echo "::error::‚ùå PINNING FALHOU ‚Äî tr√°fego interceptado via Proxy!"
            echo "mitm_result=FAIL" >> $GITHUB_OUTPUT
            exit 1 # Mantemos o Hard Gate
          fi
          echo "mitm_result=PASS" >> $GITHUB_OUTPUT
          echo "‚úÖ SSL Pinning PASSOU ‚Äî nenhum tr√°fego foi interceptado via Proxy."

      # ----------------------------------------------------------
      # 6. VALIDA√á√ÉO AVAN√áADA COM OBJECTION (Redund√¢ncia M3 e V1)
      # Esta etapa testa se a prote√ß√£o pode ser Bypassed por hooking.
      # ----------------------------------------------------------
      - name: ‚öîÔ∏è Validar Pinning com Objection (Frida Bypass)
        if: always() # Rodar mesmo se o mitm_check falhar para coleta de dados
        run: |
          if [ "${{ steps.mitm_check.outputs.mitm_result }}" == "FAIL" ]; then
            echo "Mitm j√° falhou. Pulando bypass for√ßado."
            exit 0
          fi

          echo "üõ°Ô∏è Tentando bypass de Pinning com Objection/Frida..."

          # Tenta desabilitar o Pinning no runtime do pacote alvo
          objection explore --startup-command "android sslpinning disable" --target ${{ inputs.target_package_name }}

          # Se o objection conseguiu rodar o comando, a prote√ß√£o √© fraca ou inexistente.
          if [ $? -eq 0 ]; then
            echo "::error::‚ùå PINNING FALHOU - Bypass de Frida foi bem-sucedido. Prote√ß√£o em Runtime Fraca (MASVS V1 falhou)."
            exit 1
          fi
          
          echo "‚úÖ Bypass de Frida falhou, prote√ß√£o em Runtime robusta."

          echo "‚úÖ Bypass de Frida falhou, prote√ß√£o em Runtime robusta."

      # ----------------------------------------------------------
      # 6. VALIDA√á√ÉO AVAN√áADA COM OBJECTION (Redund√¢ncia M3 e V1)
      # ----------------------------------------------------------
      - name: ‚öîÔ∏è Validar Pinning com Objection (Frida Bypass)
        if: always() # Rodar mesmo se o mitm_check falhar para coleta de dados
        run: |
          if [ "${{ steps.mitm_check.outputs.mitm_result }}" == "FAIL" ]; then
            echo "Mitm j√° falhou. Pulando bypass for√ßado."
            exit 0
          fi

          echo "üõ°Ô∏è Tentando bypass de Pinning com Objection/Frida..."

          # Tenta desabilitar o Pinning no runtime do pacote alvo
          objection explore --startup-command "android sslpinning disable" --target ${{ inputs.target_package_name }}

          # Se o objection conseguiu rodar o comando, a prote√ß√£o √© fraca ou inexistente.
          if [ $? -eq 0 ]; then
            echo "::error::‚ùå PINNING FALHOU - Bypass de Frida foi bem-sucedido. Prote√ß√£o em Runtime Fraca (MASVS V1 falhou)."
            exit 1
          fi

          echo "‚úÖ Bypass de Frida falhou, prote√ß√£o em Runtime robusta."

      # ----------------------------------------------------------
      # 6B. VALIDA√á√ÉO AVAN√áADA COM OBJECTION (Root/Jailbreak Bypass)
      # Esta etapa testa a resili√™ncia da detec√ß√£o de Root (MASVS M4/V1).
      # ----------------------------------------------------------
      - name: üõ°Ô∏è Validar Root Detection com Objection (Frida Bypass)
        if: always() # Rodar sempre para garantir o teste de resili√™ncia
        run: |
          echo "‚öîÔ∏è Tentando bypass de Root Detection com Objection/Frida..."

          # Tenta desabilitar a detec√ß√£o de root no runtime do pacote alvo
          objection explore --startup-command "android root disable" --target ${{ inputs.target_package_name }}

          # Se o objection conseguiu rodar o comando, a prote√ß√£o √© fraca ou inexistente.
          if [ $? -eq 0 ]; then
            echo "::error::‚ùå ROOT DETECTION FALHOU - Bypass de Frida foi bem-sucedido. Prote√ß√£o em Runtime Fraca (MASVS V1/M4 falhou)."
            exit 1
          fi

          echo "‚úÖ Bypass de Root Detection falhou, prote√ß√£o em Runtime robusta."

      # ----------------------------------------------------------
      # 7. Finaliza√ß√£o
      # ----------------------------------------------------------
      - name: üõë Parar Proxy e Emulador
        if: always()
        run: kill "$PROXY_PID" || true
