name: BUILD ANDROID
# âš ï¸ AVISO IMPORTANTE:
# NÃƒO ALTERAR O "name" DO WORKFLOW SEM ATUALIZAR OS WORKFLOWS QUE O REFERENCIAM!

# ===============================================================
# ðŸš€ OBJETIVO DO WORKFLOW
# Build completo do app Android em modo Release, com:
# - Build Flutter + Melos
# - GeraÃ§Ã£o do AAB oficial
# - Assinatura OIDC (cosign keyless)
# - VerificaÃ§Ã£o de assinatura (cosign verify - keyless)
# - SBOM (CycloneDX) + assinatura do SBOM
# - Provenance (SLSA-like) assinada
# - SAST: Semgrep + MobSFScan
# - SAST avanÃ§ado via DecompilaÃ§Ã£o (AAB â†’ APK â†’ apktool â†’ JADX)
# - DAST: geraÃ§Ã£o do APK universal para o job de DAST
# - Security Checks customizados
# - mapping.txt (R8/ProGuard)
# - Artefatos completos
#
# ðŸ›¡ï¸ CompatÃ­vel com:
# - OWASP Mobile Top 10
# - OWASP MASVS (L1 e L2)
# - Supply Chain Security (SLSA / Sigstore / Cosign)
# ===============================================================

# on:
#   push:
#     branches:
#       - "release/**"
#     tags:
#       - "v*"
on:
  pull_request:
    branches: [ homolog ]
  workflow_dispatch:

permissions:
  id-token: write        # (ObrigatÃ³rio para cosign keyless)
  actions: read
  contents: read
  security-events: write

concurrency:
  group: cd-android-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_release_android:
    name: "CD Android â€¢ Build + SAST + Sign + SBOM + Provenance"
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.head_ref, 'dependabot/') }}
    timeout-minutes: 20

    env:
      APP_DIR: apps/appbank
      TARGET_PACKAGE: com.example.appbank

    steps:
    # ============================================================
    # 1ï¸âƒ£ CHECKOUT E CONFIGURAÃ‡ÃƒO DO AMBIENTE
    # ============================================================
    - name: â¬‡ï¸ Checkout do cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0   # Checkout COMPLETO (recomendado para build e logs)

    - name: âš™ï¸ Configurar ambiente Flutter/Dart
      uses: ./.github/actions/setup-env

    - name: ðŸ§ª Debug inicial â€” versÃµes instaladas
      run: |
        flutter --version
        java -version || true
        flutter doctor -v || true


    # ============================================================
    # 2ï¸âƒ£ CACHES PARA ACELERAR O BUILD
    # ============================================================
    - name: â™»ï¸ Cache Pub (Flutter/Dart)
      uses: actions/cache@v4
      with:
        path: ~/.pub-cache
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: ${{ runner.os }}-pub-

    - name: â™»ï¸ Cache .dart_tool + build
      uses: actions/cache@v4
      with:
        path: |
          **/.dart_tool
          **/build
        key: ${{ runner.os }}-darttools-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: ${{ runner.os }}-darttools-

    - name: â™»ï¸ Cache Gradle (Android)
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: ${{ runner.os }}-gradle-

    - name: â™»ï¸ Cache pip (MobSF)
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: ${{ runner.os }}-pip-


    # ============================================================
    # 3ï¸âƒ£ SAST â€” SEMGREP (Flutter/Dart security rules)
    # ============================================================
    - name: ðŸ Instalar Python 3.12
      uses: actions/setup-python@v6
      with:
        python-version: "3.12"

    - name: ðŸ› ï¸ Instalar Semgrep
      run: |
        python3 -m pip install --upgrade pip
        pip install semgrep
        semgrep --version

    - name: ðŸ” Semgrep SAST (Dart/Flutter)
      run: |
        # Semgrep executa um scan com regras de seguranÃ§a e de secrets
        semgrep scan \
          --config "r/dart.flutter.security.all" \
          --config "p/secrets" \
          --sarif \
          --output semgrep-results.sarif


    # ============================================================
    # 4ï¸âƒ£ BUILD DO AAB (Flutter/Melos)
    # ============================================================
    - name: ðŸ“¦ Instalar Melos se necessÃ¡rio
      run: |
        if ! command -v melos >/dev/null; then
          dart pub global activate melos
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
        fi

    - name: ðŸ”— Melos Bootstrap
      run: melos bootstrap

    - name: ðŸ—ï¸ Build Android Release (AAB)
      run: |
        # Mantemos seu comando melos run build_app_release (nÃ£o alterado)
        melos run build_app_release
        # Gera listagem com todos os aabs produzidos (aab_paths.txt utilizado depois)
        find . -type f -name "*.aab" -print > aab_paths.txt


    # ============================================================
    # 5ï¸âƒ£ COSIGN â€” ASSINATURA OIDC DO AAB
    # ============================================================
    - name: ðŸ” Instalar Cosign (OIDC keyless)
      run: |
        VERSION="v2.4.0"
        wget -q https://github.com/sigstore/cosign/releases/download/${VERSION}/cosign-linux-amd64
        chmod +x cosign-linux-amd64
        sudo mv cosign-linux-amd64 /usr/local/bin/cosign
        cosign version

    - name: ðŸ” Verificar ofuscaÃ§Ã£o obrigatÃ³ria (release)
      shell: bash
      run: |
        set -euo pipefail
        APP_DIR="${{ env.APP_DIR }}/android/app"
        BUILD_FILE=$(find "$APP_DIR" -type f \( -name "build.gradle" -o -name "build.gradle.kts" \) | head -n1 || true)
        if [ -z "${BUILD_FILE:-}" ]; then
          echo "::error:: build.gradle(.kts) nÃ£o encontrado em $APP_DIR"
          exit 1
        fi

        # Extrai bloco release para reduzir falsos positivos
        RELEASE_BLOCK=$(awk '/buildTypes[[:space:]]*{/{flag=1} flag && /release[[:space:]]*{/{depth++} flag && depth>0{print} /\}/{if(depth>0)depth--; if(flag && depth==0){flag=0}}' "$BUILD_FILE")

        # Checa minifyEnabled (Groovy) ou isMinifyEnabled (Kotlin DSL)
        if echo "$RELEASE_BLOCK" | grep -qE 'minifyEnabled[[:space:]]+true|isMinifyEnabled[[:space:]]*=[[:space:]]*true'; then
          echo "âœ… OfuscaÃ§Ã£o habilitada em release (minifyEnabled/isMinifyEnabled)."
        else
          echo "::error:: OfuscaÃ§Ã£o R8/ProGuard nÃ£o habilitada em release. Ative minifyEnabled/isMinifyEnabled."
          exit 1
        fi

        # Checa shrinkResources (recomendado)
        if echo "$RELEASE_BLOCK" | grep -qE 'shrinkResources[[:space:]]+true|isShrinkResources[[:space:]]*=[[:space:]]*true'; then
          echo "â„¹ï¸ shrinkResources habilitado em release."
        else
          echo "::warning:: shrinkResources nÃ£o habilitado em release. Recomenda-se ativar para reduzir superfÃ­cie de ataque."
        fi

        # Alerta se release usa signingConfig debug
        if echo "$RELEASE_BLOCK" | grep -qi 'signingConfig[[:space:]]*=[[:space:]]*signingConfigs\.getByName\("debug"\)'; then
          echo "::warning:: release estÃ¡ usando signingConfig=debug. Para produÃ§Ã£o, use uma upload key dedicada/Play App Signing."
        fi

    - name: ðŸ” Assinar AAB com Cosign (OIDC - sign-blob + bundle)
      shell: bash
      env:
        COSIGN_YES: "true"   # evita prompt "Are you sure you would like to continue? [y/N]"
        # COSIGN_EXPERIMENTAL: "true"  # somente se sua versÃ£o exigir para keyless/oidc (na maioria das versÃµes atuais nÃ£o Ã© necessÃ¡rio)
      run: |
        set -euo pipefail
        AAB="${{ env.APP_DIR }}/build/app/outputs/bundle/release/app-release.aab"
        BUNDLE="${{ env.APP_DIR }}/app-release.bundle.json"
        SIG="${{ env.APP_DIR }}/app-release.sig"
        if [ ! -f "$AAB" ]; then
          echo "::error:: AAB esperado nÃ£o encontrado: $AAB"
          exit 1
        fi
        echo "ðŸ” Assinando blob $AAB com Cosign (keyless OIDC)..."
        cosign sign-blob "$AAB" \
          --bundle "$BUNDLE" \
          --output-signature "$SIG" \
          --yes
        echo "âœ… Assinatura gerada: $SIG e bundle: $BUNDLE"


    - name: ðŸ” Verificar assinatura (Cosign verify - keyless)
      run: |
        # Em modo keyless, a verificaÃ§Ã£o exige:
        #  - --certificate-identity-regexp  (quem assinou)
        #  - --certificate-oidc-issuer      (issuer do token OIDC)
        set -euo pipefail
        AAB="${{ env.APP_DIR }}/build/app/outputs/bundle/release/app-release.aab"
        BUNDLE="${{ env.APP_DIR }}/app-release.bundle.json"

        if [ ! -f "$AAB" ]; then
          echo "âš ï¸ AAB nÃ£o encontrado ($AAB) â€” pulando cosign verify."
          exit 0
        fi
        if [ ! -f "$BUNDLE" ]; then
          echo "âš ï¸ Bundle JSON nÃ£o encontrado ($BUNDLE) â€” pulando cosign verify."
          exit 0
        fi

        # Usamos uma regexp genÃ©rica que corresponde a workflows no repo.
        # Se quiser restringir: substitua por um caminho exato do arquivo de workflow.
        CERT_ID_REGEXP="https://github.com/${GITHUB_REPOSITORY}/.github/workflows/.*@.*"
        OIDC_ISSUER="https://token.actions.githubusercontent.com"

        cosign verify-blob \
          --bundle "$BUNDLE" \
          --certificate-identity-regexp "$CERT_ID_REGEXP" \
          --certificate-oidc-issuer "$OIDC_ISSUER" \
          "$AAB"

        echo "âœ… Cosign verification OK for $AAB"


    # ============================================================
    # 6ï¸âƒ£ UPLOAD DOS ARTEFATOS ASSINADOS
    # ============================================================
    - name: ðŸ§­ Debug â€” listar arquivos assinados
      run: |
        echo "Listing signed AAB output dir:"
        ls -la "${{ env.APP_DIR }}/build/app/outputs/bundle/release" || true
        echo "Listing app dir for signatures:"
        ls -la "${{ env.APP_DIR }}" | grep -E '\.sig$|\.bundle.json$' || true

    - name: ðŸ“¤ Upload signed AAB artifacts
      uses: actions/upload-artifact@v4
      with:
        name: signed-aab
        path: |
          ${{ env.APP_DIR }}/build/app/outputs/bundle/release/*.aab
          ${{ env.APP_DIR }}/*.sig
          ${{ env.APP_DIR }}/*.bundle.json
        retention-days: 7  
        if-no-files-found: warn


    # ============================================================
    # 7ï¸âƒ£ SBOM + ASSINATURA + PROVENANCE
    # ============================================================
    - name: ðŸ§© Instalar Trivy
      run: |
        sudo apt-get update -y
        sudo apt-get install -y wget apt-transport-https gnupg lsb-release jq
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" \
          | sudo tee /etc/apt/sources.list.d/trivy.list
        sudo apt-get update -y
        sudo apt-get install -y trivy

    - name: ðŸ§© Gerar SBOM (CycloneDX)
      working-directory: ${{ env.APP_DIR }}
      run: |
        # Gera SBOM com Trivy em formato CycloneDX. Mantemos WARN se nÃ£o houver dependÃªncias.        
        trivy fs . --security-checks vuln,license --format cyclonedx -o sbom.json

    - name: ðŸ” Assinar SBOM com Cosign
      working-directory: ${{ env.APP_DIR }}
      run: |
        if [ -f sbom.json ]; then
          cosign sign-blob sbom.json \
            --yes \
            --bundle sbom.bundle.json \
            --output-signature sbom.sig || true
        else
          echo "âš ï¸ sbom.json nÃ£o encontrado â€” skip sign"
        fi

    - name: ðŸ“¤ Upload SBOM
      uses: actions/upload-artifact@v4
      with:
        name: sbom
        path: |
          ${{ env.APP_DIR }}/sbom.json
          ${{ env.APP_DIR }}/sbom.sig
          ${{ env.APP_DIR }}/sbom.bundle.json
        retention-days: 7
        if-no-files-found: warn


    # ============================================================
    # 8ï¸âƒ£ PROVENANCE (SLSA-like)
    # ============================================================
    - name: ðŸ§¾ Criar provenance.json
      working-directory: ${{ env.APP_DIR }}
      run: |
        cat > provenance.json <<EOF
        {
          "type": "slsa-provenance",
          "version": "1.0",
          "repo": "${{ github.repository }}",
          "commit": "${{ github.sha }}",
          "builder": "github-actions",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        }
        EOF

    - name: ðŸ” Assinar Provenance
      working-directory: ${{ env.APP_DIR }}
      run: |
        if [ -f provenance.json ]; then
          cosign sign-blob provenance.json \
            --yes \
            --output-signature provenance.sig \
            --bundle provenance.bundle.json || true
        else
          echo "âš ï¸ provenance.json nÃ£o encontrado â€” skip sign"
        fi

    - name: ðŸ“¤ Upload Provenance
      uses: actions/upload-artifact@v4
      with:
        name: provenance
        path: |
          ${{ env.APP_DIR }}/provenance.json
          ${{ env.APP_DIR }}/provenance.sig
          ${{ env.APP_DIR }}/provenance.bundle.json
        retention-days: 7
        if-no-files-found: warn


    # ============================================================
    # 9ï¸âƒ£ mapping.txt (R8/ProGuard) â€” robusto e nÃ£o-falha silenciosamente
    # ============================================================
    - name: ðŸ” Verificar ofuscaÃ§Ã£o (isMinifyEnabled) e coletar mapping.txt
      shell: bash
      run: |
        set -euo pipefail

        APP_DIR="${{ env.APP_DIR }}"
        echo "Procurando build file em: $APP_DIR/android/app/"

        # Procura explicitamente dentro do app android correspondente
        BUILD_FILE=$(find "$APP_DIR" -type f \( -path "*/android/app/build.gradle" -o -path "*/android/app/build.gradle.kts" \) 2>/dev/null | head -n 1 || true)

        if [ -z "$BUILD_FILE" ]; then
          echo "âš ï¸ build.gradle(.kts) nÃ£o encontrado em $APP_DIR/android/app/ â€” nÃ£o Ã© possÃ­vel verificar isMinifyEnabled."
          # Se vocÃª prefere que isso quebre o release, substitua a linha abaixo por: exit 1
        else
          echo "Arquivo de build encontrado em: $BUILD_FILE"

          # Testa por minifyEnabled true (PadrÃ£o Gradle / Kotlin DSL variations)
          if grep -qE "minifyEnabled\s*true" "$BUILD_FILE"; then
            echo "âœ… minifyEnabled = true (ofuscaÃ§Ã£o ativada)."
          else
            echo "âŒ minifyEnabled NÃƒO encontrado como 'true' no build file."
            # Se quer bloquear o release quando ofuscaÃ§Ã£o estiver desativada, descomente exit 1 abaixo:
            # exit 1
          fi
        fi

        # Localiza mapping.txt (prefer release paths)
        MAPPING_FILE=$(find "$APP_DIR" -type f -iname "mapping.txt" 2>/dev/null | grep -i "release" | head -n 1 || true)

        mkdir -p artifacts

        if [ -n "$MAPPING_FILE" ] && [ -f "$MAPPING_FILE" ]; then
          echo "âœ… mapping.txt encontrado: $MAPPING_FILE"
          cp "$MAPPING_FILE" artifacts/mapping.txt
        else
          echo "âš ï¸ mapping.txt nÃ£o encontrado. Se ofuscaÃ§Ã£o foi ativada, verifique se o build gerou mapping.txt (R8/ProGuard)."
        fi


    # ============================================================
    # ðŸ”Ÿ DECOMPILAÃ‡ÃƒO (APKTool + JADX) â€” SAST AVANÃ‡ADO (robusto)
    # ============================================================
    - name: Install JADX
      run: |
        wget -q https://github.com/skylot/jadx/releases/download/v1.5.1/jadx-1.5.1.zip -O jadx.zip
        unzip -q jadx.zip -d jadx
        sudo ln -sf "$(pwd)/jadx/bin/jadx" /usr/local/bin/jadx

    - name: ðŸ” Decompilar e Extrair SAST (bundletool -> universal.apk -> jadx)
      shell: bash
      run: |
        set -euo pipefail

        APP_DIR="${{ env.APP_DIR }}"
        AAB="$APP_DIR/build/app/outputs/bundle/release/app-release.aab"

        echo "Preparando diretÃ³rios..."
        mkdir -p sast_tmp sast_tools sast_reports

        if [ ! -f "$AAB" ]; then
          echo "âŒ AAB nÃ£o encontrado em: $AAB"
          echo "Listando conteÃºdo de $APP_DIR/build/app/outputs/bundle/release:"
          ls -la "$APP_DIR/build/app/outputs/bundle/release" || true
          exit 1
        fi

        echo "Baixando bundletool..."
        curl -sSL -o sast_tools/bundletool.jar https://github.com/google/bundletool/releases/download/1.11.0/bundletool-all-1.11.0.jar

        echo "Gerando .apks com bundletool..."
        java -jar sast_tools/bundletool.jar build-apks \
          --bundle="$AAB" \
          --output=sast_tmp/universal.apks \
          --mode=universal || true

        echo "Extraindo universal.apks..."
        unzip -qo sast_tmp/universal.apks -d sast_tmp/universal_dir || true

        echo "Procurando por universal/apk dentro do diretÃ³rio extraÃ­do..."
        UNIVERSAL_APK=$(find sast_tmp/universal_dir -type f -name "*.apk" | head -n 1 || true)

        if [ -z "$UNIVERSAL_APK" ]; then
          echo "âŒ universal.apk nÃ£o encontrado dentro de universal.apks"
          echo "ConteÃºdo extraÃ­do:"
          find sast_tmp/universal_dir -maxdepth 5 -type f -print || true
          exit 1
        fi

        echo "Copiando APK universal para lokasi padrÃ£o..."
        cp "$UNIVERSAL_APK" sast_tmp/app-universal.apk

        echo "Rodando JADX..."
        jadx -d sast_tmp/jadx sast_tmp/app-universal.apk || true

        echo "Extraindo padrÃµes SSL/TLS para anÃ¡lise rÃ¡pida..."
        grep -RIn "CertificatePinner" sast_tmp/jadx > sast_reports/ssl.txt || true
        grep -RIn "TrustManager|X509TrustManager|checkServerTrusted|hostnameVerifier" sast_tmp/jadx > sast_reports/ssl_more.txt || true

        echo "DecompilaÃ§Ã£o concluÃ­da (relatÃ³rios em sast_reports)."


    - name: ðŸ“¤ Upload SAST reports
      uses: actions/upload-artifact@v4
      with:
        name: sast-reports
        path: sast_reports/**
        retention-days: 7
        if-no-files-found: warn


    # ============================================================
    # 1ï¸âƒ£1ï¸âƒ£ DAST â€” gerar APK universal para o job de pinning
    # ============================================================
    - name: ðŸ“¦ Exportar APK universal para DAST
      run: |
        mkdir -p dast_artifacts
        if [ -f sast_tmp/app-universal.apk ]; then
          cp sast_tmp/app-universal.apk dast_artifacts/
        else
          echo "âŒ APK universal nÃ£o encontrado (sast_tmp/app-universal.apk)."
          exit 1
        fi

    - name: ðŸ“¤ Upload APK universal (DAST)
      uses: actions/upload-artifact@v4
      with:
        name: dast-universal-apk
        path: dast_artifacts/
        retention-days: 7
        if-no-files-found: warn


    # ============================================================
    # 1ï¸âƒ£2ï¸âƒ£ SECURITY CHECKS CUSTOMIZADOS
    # ============================================================
    - name: ðŸ›¡ï¸ðŸ›¡ï¸ðŸ›¡ï¸ Executar scripts do security-checks.sh ðŸ›¡ï¸ðŸ›¡ï¸ðŸ›¡ï¸
      shell: bash
      run: |
        set -euo pipefail

        if [ ! -f ./scripts/security-checks.sh ]; then
          echo "âš ï¸ scripts/security-checks.sh nÃ£o encontrado â€” abortando."
          exit 1
        fi

        chmod +x scripts/security-checks.sh

        # executa o script mas NÃƒO sai imediatamente para que possamos capturar logs
        set +e
        ./scripts/security-checks.sh
        EXIT_CODE=$?
        set -e

        if [ $EXIT_CODE -ne 0 ]; then
          echo "âŒ scripts/security-checks.sh retornou cÃ³digo de saÃ­da: $EXIT_CODE"
          echo "ðŸ“ Listagem de arquivos relevantes (sast_reports / artifacts):"
          ls -la sast_reports || true
          ls -la artifacts || true

          echo "ðŸ“ Ãšltimas linhas dos relatÃ³rios SAST (atÃ© 200 linhas por arquivo):"
          for f in sast_reports/*; do
            if [ -f "$f" ]; then
              echo "----- $f -----"
              tail -n 200 "$f" || true
            fi
          done

          echo "ðŸ” Se preferir, abra os logs completos no GitHub Actions (step logs)."
          # repropaga o erro para falhar o job (com motivo visÃ­vel)
          exit $EXIT_CODE
        fi

        echo "âœ… scripts/security-checks.sh finalizou com sucesso (exit 0)."


    # ============================================================
    # 1ï¸âƒ£3ï¸âƒ£ SAST via MobSFScan (pip)
    # ============================================================
    - name: Instalar MobSFScan
      run: |
        set -e
        echo "ðŸ“¦ Instalando MobSFScan e dependÃªncias..."
        python -m pip install --upgrade pip
        pip install --upgrade mobsfscan jq || {
          echo "::error::âŒ Falha ao instalar MobSFScan."
          exit 1
        }
        echo "âœ”ï¸ MobSFScan versÃ£o:"
        mobsfscan -v || true

    # ============================================================
    # ExecuÃ§Ã£o (quebra sÃ³ em CRITICAL/HIGH)
    # v0.4.5: precisa rodar separadamente --json e --sarif
    # ============================================================
    - name: Executar MobSFScan
      id: mobsf-scan
      shell: bash
      run: |
        set -euo pipefail

        CUSTOM_RULES_PATH="./mobsf_custom_rules.yaml"
        APK_UNIVERSAL="sast_tmp/app-universal.apk"
        APK_RELEASE="${APP_DIR}/build/app/outputs/flutter-apk/app-release.apk"
        AAB_PATH="${APP_DIR}/build/app/outputs/bundle/release/app-release.aab"

        if [ -f "$APK_UNIVERSAL" ]; then
          SCAN_TARGET="$APK_UNIVERSAL"
        elif [ -f "$APK_RELEASE" ]; then
          SCAN_TARGET="$APK_RELEASE"
        elif [ -f "$AAB_PATH" ]; then
          echo "âš ï¸ Usando AAB (suporte limitado). Preferir APK universal."
          SCAN_TARGET="$AAB_PATH"
        else
          echo "âŒ Nenhum APK/AAB encontrado para scan."
          ls -la "${APP_DIR}/build/app/outputs" || true
          exit 1
        fi

        echo "ðŸ”Ž Target MobSFScan: $SCAN_TARGET"

        CONFIG_ARG=()
        if [ -f "$CUSTOM_RULES_PATH" ]; then
          echo "âœ”ï¸ Regras custom: $CUSTOM_RULES_PATH"
          CONFIG_ARG+=(--config "$CUSTOM_RULES_PATH")
        else
          echo "âš ï¸ Regras custom ausentes (usando padrÃ£o)."
        fi

        # ExecuÃ§Ã£o JSON (v0.4.5: uma saÃ­da por vez)
        set +e
        mobsfscan --json -o mobsfscan-report.json "${CONFIG_ARG[@]}" "$SCAN_TARGET"
        EXIT_JSON=$?
        set -e

        if [ $EXIT_JSON -ne 0 ]; then
          echo "âš ï¸ mobsfscan (JSON) retornou cÃ³digo $EXIT_JSON"
        fi
        if [ ! -f mobsfscan-report.json ]; then
          echo "::error::âŒ mobsfscan-report.json nÃ£o gerado."
          ls -la .
          exit 1
        fi

        # ExecuÃ§Ã£o SARIF opcional
        set +e
        mobsfscan --sarif -o mobsfscan-report.sarif "${CONFIG_ARG[@]}" "$SCAN_TARGET"
        EXIT_SARIF=$?
        set -e
        [ $EXIT_SARIF -ne 0 ] && echo "âš ï¸ mobsfscan (SARIF) falhou (tolerado)."

        echo "ðŸ“Š Processando severidades..."
        CRITICAL_COUNT=$(jq '[.issues? // .results? | .[] | select(.severity=="CRITICAL")] | length' mobsfscan-report.json)
        HIGH_COUNT=$(jq '[.issues? // .results? | .[] | select(.severity=="HIGH")] | length' mobsfscan-report.json)

        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo " MobSFScan Summary"
        echo " CRITICAL: $CRITICAL_COUNT"
        echo " HIGH:     $HIGH_COUNT"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

        if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
          echo "::error::ðŸš¨ MobSFScan encontrou vulnerabilidades CRITICAL/HIGH."
          exit 1
        fi

        echo "âœ… Nenhuma CRITICAL/HIGH detectada."

    - name: Upload MobSF reports
      uses: actions/upload-artifact@v4
      with:
        name: mobsf
        path: |
          mobsfscan-report.json
          mobsfscan-report.sarif
        retention-days: 3
        if-no-files-found: warn


    # ============================================================
    # 1ï¸âƒ£4ï¸âƒ£ TAG DE RELEASE AUTOMÃTICA
    # ============================================================
    - name: ðŸ·ï¸ Criar Tag AutomÃ¡tica
      if: ${{ success() && startsWith(github.ref, 'refs/heads/release/') }}
      run: |
        VERSION=${GITHUB_REF#refs/heads/release/}
        TAG="v${VERSION}"

        echo "ðŸ·ï¸ SolicitaÃ§Ã£o de criaÃ§Ã£o da tag: $TAG"

        # MantÃ©m o comportamento original,
        # mas impede que a tag existente quebre o pipeline.
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "âš ï¸ A tag $TAG jÃ¡ existe (comportamento original mantido)."
          echo "â„¹ï¸ Ignorando criaÃ§Ã£o da tag para evitar falha no job."
          exit 0
        fi

        # Comportamento original (criaÃ§Ã£o da tag idÃªntica)
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git tag -a "$TAG" -m "Release $VERSION"
        git push origin "$TAG"

        echo "âœ… Tag $TAG criada com sucesso."



    # ============================================================
    # 1ï¸âƒ£5ï¸âƒ£ SUMÃRIO FINAL â€” VISUAL REFINADO
    # ============================================================
    - name: ðŸ“„ SUMÃRIO FINAL
      if: always()
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ  FINAL DO PIPELINE â€” RELATÃ“RIO EXECUTIVO"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""

        echo "ðŸ“¦ **Build & Artefatos**"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        if [ -f aab_paths.txt ]; then
          echo "âœ”ï¸ Arquivo aab_paths.txt encontrado:"
          cat aab_paths.txt
        else
          echo "âŒ Nenhum AAB encontrado."
        fi
        echo ""

        echo "ðŸ§µ **Artefatos do AAB (Release)**  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        ls -la ${{ env.APP_DIR }}/build/app/outputs/bundle/release 2>/dev/null || echo "âŒ Sem artefatos de bundle encontrados."
        echo ""

        echo "ðŸ” **Assinatura (Cosign)**  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        if ls ${{ env.APP_DIR }}/*.sig >/dev/null 2>&1; then
          echo "âœ”ï¸ Assinatura Cosign gerada:"
          ls -la ${{ env.APP_DIR }}/*.sig
        else
          echo "âŒ Nenhuma assinatura .sig encontrada."
        fi
        if ls ${{ env.APP_DIR }}/*.bundle.json >/dev/null 2>&1; then
          echo "âœ”ï¸ Bundle de transparÃªncia:"
          ls -la ${{ env.APP_DIR }}/*.bundle.json
        else
          echo "âŒ Nenhum bundle JSON encontrado."
        fi
        echo ""

        echo "ðŸ“œ **SBOM (CycloneDX)**  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        if [ -f "${{ env.APP_DIR }}/sbom.json" ]; then
          echo "âœ”ï¸ SBOM gerada:"
          ls -la ${{ env.APP_DIR }}/sbom.json
        else
          echo "âŒ SBOM nÃ£o encontrada."
        fi
        echo ""

        echo "ðŸ§¬ **Provenance (SLSA-Like)** â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        if [ -f "${{ env.APP_DIR }}/provenance.json" ]; then
          echo "âœ”ï¸ Provenance gerada:"
          ls -la ${{ env.APP_DIR }}/provenance.json
        else
          echo "âŒ Provenance nÃ£o encontrada."
        fi
        echo ""

        echo "ðŸ›¡ï¸ **SAST â€” DecompilaÃ§Ã£o + AnÃ¡lises**  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        if [ -d sast_reports ]; then
          echo "âœ”ï¸ RelatÃ³rios SAST disponÃ­veis:"
          ls -la sast_reports
        else
          echo "âŒ Nenhum relatÃ³rio SAST encontrado."
        fi
        echo ""

        echo "ðŸ“± **MobSFScan**  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        if [ -f mobsf.json ]; then
          echo "âœ”ï¸ RelatÃ³rio MobSFScan:"
          ls -la mobsf.json
        else
          echo "âŒ Nenhum relatÃ³rio MobSFScan encontrado."
        fi
        echo ""

        echo "ðŸ§ª **DAST â€” SSL Pinning**  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        if [ -d dast_artifacts ]; then
          echo "âœ”ï¸ APK universal para DAST:"
          ls -la dast_artifacts
        else
          echo "âŒ Nenhum artefato DAST encontrado."
        fi
        echo ""

        echo "ðŸ“¦ **mapping.txt (R8/ProGuard)**  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        if [ -f artifacts/mapping.txt ]; then
          echo "âœ”ï¸ mapping.txt disponÃ­vel:"
          ls -la artifacts/mapping.txt
        else
          echo "âš ï¸ mapping.txt nÃ£o encontrado (possÃ­vel build sem R8 ativo)"
        fi
        echo ""

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸŽ‰   PIPELINE FINALIZADA â€” TODOS OS PASSOS EXECUTADOS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"


    - name: ðŸ§¾ RESUMO EXECUTIVO (Badges)
      if: always()
      run: |
        {
          echo "# ðŸš€ RESUMO FINAL DO PIPELINE ANDROID"
          echo ""
          echo "## âœ… Etapas Executadas"
          echo "- â¬‡ï¸ Checkout & Setup Flutter/Melos"
          echo "- â™»ï¸ Caches (Pub / Dart Tool / Gradle / pip)"
          echo "- ðŸ” Semgrep SAST"
          echo "- ðŸ—ï¸ Build Release (AAB)"
          echo "- ðŸ” Cosign Sign + Verify"
          echo "- ðŸ“¤ Upload AAB Assinado"
          echo "- ðŸ§© SBOM (CycloneDX) + Assinatura"
          echo "- ðŸ§¬ Provenance + Assinatura"
          echo "- ðŸ—ºï¸ mapping.txt (R8/ProGuard)"
          echo "- ðŸ” DecompilaÃ§Ã£o (bundletool â†’ universal.apk â†’ JADX)"
          echo "- ðŸ“„ RelatÃ³rios SAST (ssl.txt / ssl_more.txt)"
          echo "- ðŸ“¦ APK Universal para DAST"
          echo "- ðŸ›¡ï¸ security-checks.sh (checks customizados)"
          echo "- ðŸ“± MobSFScan (CRITICAL/HIGH gate)"
          echo "- ðŸ·ï¸ Tag automÃ¡tica (se branch release/*)"
          echo ""
          if [ "${{ job.status }}" = "success" ]; then
            echo "## ðŸŸ¢ Status Final: **SUCESSO TOTAL**"
            echo "![success](https://img.shields.io/badge/Android%20CD-Sucesso-brightgreen?style=for-the-badge&logo=android)"
          else
            echo "## ðŸ”´ Status Final: **FALHA NO PIPELINE**"
            echo "![fail](https://img.shields.io/badge/Android%20CD-Falhou-red?style=for-the-badge&logo=android)"
          fi
          echo ""
          echo "## ðŸ“Œ Contexto"
          echo "- Workflow: ${{ github.workflow }}"
          echo "- Branch/Ref: ${{ github.ref_name }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Actor: ${{ github.actor }}"
          echo ""
          echo "## ðŸ“¦ Artefatos Principais"
          if [ -f "${{ env.APP_DIR }}/build/app/outputs/bundle/release/app-release.aab" ]; then
            echo "- AAB: OK"
          else
            echo "- AAB: NÃƒO GERADO"
          fi
          if [ -f "${{ env.APP_DIR }}/provenance.json" ]; then
            echo "- Provenance: OK"
          else
            echo "- Provenance: AUSENTE"
          fi
          if [ -f "${{ env.APP_DIR }}/sbom.json" ]; then
            echo "- SBOM: OK"
          else
            echo "- SBOM: AUSENTE"
          fi
          if [ -f "sast_tmp/app-universal.apk" ]; then
            echo "- APK Universal (DAST): OK"
          else
            echo "- APK Universal (DAST): AUSENTE"
          fi
          if [ -f "artifacts/mapping.txt" ]; then
            echo "- mapping.txt: OK"
          else
            echo "- mapping.txt: AUSENTE"
          fi
          echo ""
          echo "## ðŸ” Assinaturas"
          ls -1 "${{ env.APP_DIR }}"/*.sig 2>/dev/null || echo "Sem *.sig"
          echo ""
          echo "## ðŸ›¡ï¸ ObservaÃ§Ãµes"
          echo "- Verifique MobSFScan para vulnerabilidades nÃ£o bloqueantes (LOW/MEDIUM)."
          echo "- Use o APK universal no workflow DAST para validar SSL Pinning."
        } >> "$GITHUB_STEP_SUMMARY"


  # ============================================================
  # ðŸ”„ JOB SEPARADO: DAST (SSL Pinning)
  # Executado somente apÃ³s build_release_android
  # ============================================================
  security_gate_dast:
    name: "ðŸ§ª DAST â€” SSL Pinning"
    needs: build_release_android

    uses: AlexandreTSato/BankModel/.github/workflows/cd-android-dast-pinning.yml@release/1.0.0

    with:
      apk_artifact_name: dast-universal-apk
      target_package_name: com.example.appbank
