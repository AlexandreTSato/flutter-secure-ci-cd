name: üö®üö®üö® Android Deploy Google Play Store

on:   
  workflow_run:
    workflows: ["CD ANDROID DAST"] 
    types: 
      - completed
      
permissions:
  contents: read
  security-events: write
  actions: read 
  issues: write # Permite que o ZAP Action crie Issues (Problemas) no GitHub

jobs:
  zap_dast_scan:
    runs-on: ubuntu-latest
    

    # ‚è±Ô∏è Tempo limite total para o job
    timeout-minutes: 20
    
    # Executa apenas se o workflow anterior foi conclu√≠do com sucesso ou se for execu√ß√£o manual
    if: |      
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'workflow_run' && 
       github.event.workflow_run.conclusion == 'success' &&      
       contains(github.event.workflow_run.head_branch, 'release'))

    steps:
      - name: ‚¨áÔ∏è Teste
        uses: actions/checkout@v4


      # ----------------------------
      # PASSO NOVO 1A: Tentar Restaurar a Instala√ß√£o do Cosign
      # ----------------------------
      - name: ‚¨áÔ∏è Cache de Instala√ß√£o do Cosign
        id: cache-cosign
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/cosign # Ou o caminho onde o Cosign √© instalado/usado (geralmente /usr/local/bin)
          key: ${{ runner.os }}-cosign-v1.0 # Use uma chave que invalida quando a vers√£o do Cosign muda

      # ----------------------------
      # PASSO NOVO 1B: Instalar Cosign APENAS se o cache falhar (cache-hit != true)
      # ----------------------------
      - name: üõ†Ô∏è Instalar Cosign (Sigstore)
        if: steps.cache-cosign.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          echo "Instalando Cosign..."
          # Re-executa o comando de instala√ß√£o se o cache falhou
          curl -sL https://install.sigstore.dev/cosign | sh
          
          # Move para um diret√≥rio que ser√° cacheado/acess√≠vel globalmente se n√£o estiver no $PATH
          # Se o 'curl | sh' j√° move para /usr/local/bin, o cache-hit deve funcionar. 
          # Caso contr√°rio, mova o bin√°rio (ex: mv $HOME/bin/cosign /usr/local/bin)
          
      # ----------------------------
      # PASSO NOVO 2: Baixar Artefatos (Permanentemente Necess√°rio)
      # ----------------------------
      - name: ‚¨áÔ∏è Baixar Artefatos Assinados (SBOM/Provenance)
        uses: actions/download-artifact@v4
        with:
          name: release_artifacts
          path: ./release_artifacts
          run-id: ${{ github.event.workflow_run.id }} 

      # ----------------------------
      # üîé PASSO 3: Verificar Provenance and SBOM Signatures
      # (Agora com os caminhos corretos)
      # ----------------------------
      - name: üîé Verify provenance & SBOM signatures with Cosign
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euo pipefail
          echo "üîê Verifying signed artifacts before Play Store upload..."
          
          # Verifica assinatura da proveni√™ncia
          cosign verify-blob --signature ./release_artifacts/provenance.sig ./release_artifacts/provenance.json
      
          # Verifica assinatura do SBOM CycloneDX
          cosign verify-blob --signature ./release_artifacts/sbom.sig ./release_artifacts/sbom.json
      
          # Verifica assinatura do AAB release (opcional, se assinado via cosign)
          if [ -f ./release_artifacts/app-release.aab.sig ]; then
            cosign verify-blob --signature ./release_artifacts/app-release.aab.sig ./release_artifacts/app-release.aab
          fi
      
          echo "‚úÖ All signatures verified successfully. Proceeding to publish..."


#     - name: üöÄ Upload to Google Play
#   uses: r0adkll/upload-google-play@v3
#   with:
#     serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
#     packageName: com.seubanco.app
#     releaseFiles: app-release.aab

